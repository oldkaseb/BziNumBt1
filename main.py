# -*- coding: utf-8 -*-

import os
import logging
import random
import io
import asyncio
from datetime import datetime
from telegram import (
    Update,
    InlineKeyboardButton,
    InlineKeyboardMarkup,
    ChatMember,
    ChatMemberUpdated,
)
from telegram.ext import (
    Application,
    CommandHandler,
    ContextTypes,
    MessageHandler,
    filters,
    CallbackQueryHandler,
    ChatMemberHandler,
    ConversationHandler,
)
from telegram.constants import ParseMode, ChatMemberStatus
import psycopg2
from PIL import Image, ImageDraw, ImageFont
import arabic_reshaper
from bidi.algorithm import get_display

# --- Main Configuration ---
OWNER_IDS = [7662192190, 6041119040]
SUPPORT_USERNAME = "OLDKASEB"
FORCED_JOIN_CHANNEL = "@RHINOSOUL_TM"
GROUP_INSTALL_LIMIT = 50
INITIAL_LIVES = 6
# --- Conversation States ---
(ASKING_GOD_USERNAME, CONFIRMING_GOD, DOOZ_ASKING_OPPONENT, ETERAF_ASKING_CUSTOM_TEXT) = range(4)

# --- Word & Sentence Lists (Unchanged) ---
WORD_LIST = [
    "ูุถุงูพูุง", "ฺฉูฺฉุดุงู", "ุงูฺฏูุฑุชู", "ฺฉุชุงุจุฎุงูู", "ุฏุงูุดฺฏุงู", "ฺฉุงููพูุชุฑ", "ุงูุชุฑูุช", "ุจุฑูุงูู", "ููุณ", "ููุด", "ูุตููุน", "ุงุฏฺฏุฑ", "ูุงุดู", "ุดุจฺฉู", "ุนุตุจ", "ุฏุงุฏู", "ฺฉุงู", "ูพุงุชูู", "ุฌุงูุง", "ุงุณฺฉุฑูพุช", 
    "ููุงูุฑ", "ุงุทูุงุนุงุช", "ุงููุช", "ุณุงุจุฑ", "ุญููู", "ูุฑูุณ", "ุจุฏุงูุฒุงุฑ", "ุขูุช", "ูุฑูุณ", "ุฏูุงุฑ", "ุขุชุด", "ุฑูุฒูฺฏุงุฑ", "ูพุฑูุชฺฉู", "ุฏุงููู", "ูุฒุจุงู", "ูุจ", "ุณุฑูุฑ", "ฺฉูุงูุช", "ูพุงฺฏุงู", "ุฏุงุฏู", 
    "ุฑุงุจุท", "ฺฉุงุฑุจุฑ", "ุชุฌุฑุจู", "ฺฉุงุฑุจุฑ", "ุทุฑุงุญ", "ฺฏุฑุงูฺฉ", "ุงููุดู", "ุณู", "ุจุนุฏ", "ูุงูุนุช", "ูุฌุงุฒ", "ุงูุฒูุฏู", "ุจูุงฺฉฺู", "ุงุฑุฒ", "ุฏุฌุชุงู", "ุจุชฺฉูู", "ุงุชุฑูู", "ูุฑุงุฑุฏุงุฏ", "ููุดููุฏ", "ูุชุงูุฑุณ", 
    "ุงุดุงุก", "ุฑุจุงุชฺฉ", "ุฎูุฏุฑู", "ุฎูุฏุฑุงู", "ูพููพุงุฏ", "ุณูุณูุฑ", "ูพุฑุฏุงุฒุด", "ุชุตูุฑ", "ุณฺฏูุงู", "ูุฎุงุจุฑุงุช", "ูุงููุงุฑู", "ูุฑฺฉุงูุณ", "ููุฌ", "ุงูฺฉุชุฑููุบูุงุทุณ", "ูุฒฺฉ", "ฺฉูุงูุชูู", "ูุณุจุช", "ุงูุดุชู", "ููุชู", 
    "ฺฏุฑุงูุด", "ุณุงูฺุงูู", "ุณุชุงุฑู", "ููุชุฑูู", "ุงููุฌุงุฑ", "ุจุฒุฑฺฏ", "ฺฉูุงู", "ุดูุงุณ", "ุงุฎุชุฑ", "ูุฒฺฉ", "ุดู", "ุขู", "ูุนุฏู", "ุชุฌุฒู", "ุจูุดู", "ฺูุชฺฉ", "ุณููู", "ุจุงูุช", "ุงุฑฺฏุงู", "ูุชุงุจููุณู", 
    "ูุชูุณูุชุฒ", "ุชููุณ", "ุณููู", "ุฒุณุช", "ุดูุงุณ", "ูฺฉุฑูุจูููฺ", "ุจุงฺฉุชุฑ", "ูุงุฑฺ", "ูพุฒุดฺฉ", "ุฏุงุฑูุณุงุฒ", "ุฌุฑุงุญ", "ููุจ", "ูุบุฒ", "ุงุนุตุงุจ", "ุฑูุงูุดูุงุณ", "ุฌุงูุนู", "ุดูุงุณ", "ุงูุชุตุงุฏ", "ุจุงุฒุงุฑ", 
    "ุณุฑูุงู", "ุจูุฑุณ", "ุณูุงู", "ุชูุฑู", "ุฑฺฉูุฏ", "ุฑุดุฏ", "ุงูุชุตุงุฏ", "ุชููุฏ", "ูุงุฎุงูุต", "ุฏุงุฎู", "ุตุงุฏุฑุงุช", "ูุงุฑุฏุงุช", "ุชุฌุงุฑุช", "ุจู", "ุงูููู", "ุณุงุณุช", "ุฏููฺฉุฑุงุณ", "ุฏฺฉุชุงุชูุฑ", "ุฌูููุฑ", "ูพุงุฏุดุงู", 
    "ุงูุชุฎุงุจุงุช", "ูพุงุฑููุงู", "ุฏููุช", "ููู", "ูุถุงุฆู", "ุชุงุฑุฎ", "ุจุงุณุชุงู", "ูุนุงุตุฑ", "ุฌูฺฏ", "ุฌูุงู", "ุตูุจ", "ุฑูุณุงูุณ", "ุงุตูุงุญุงุช", "ุฏู", "ุงูููุงุจ", "ุตูุนุช", "ููุณูู", "ููุทู", "ุงุฎูุงู", "ุฒุจุง", 
    "ุดูุงุณ", "ุงููุงุทูู", "ุงุฑุณุทู", "ุณูุฑุงุท", "ุฏฺฉุงุฑุช", "ฺฉุงูุช", "ูฺู", "ุงุฏุจุงุช", "ุดุนุฑ", "ุฑูุงู", "ุฏุงุณุชุงู", "ฺฉูุชุงู", "ููุงุดูุงูู", "ุญุงูุธ", "ุณุนุฏ", "ูุฑุฏูุณ", "ูููุงูุง", "ุฎุงู", "ุดฺฉุณูพุฑ", "ุชููุณุชู", 
    "ุฏุงุณุชุงููุณฺฉ", "ููุฑ", "ููุงุด", "ูุฌุณูู", "ุณุงุฒ", "ูุนูุงุฑ", "ููุณู", "ุณููุง", "ุชุฆุงุชุฑ", "ุนฺฉุงุณ", "ุฎูุฑุดุฏ", "ุณุงุฑู", "ูุฑุฎ", "ุฒูู", "ูุดุชุฑ", "ุงูุฑุงููุณ", "ููพุชูู", "ุฒูุฑู", "ุนุทุงุฑุฏ", "ุณุชุงุฑู", 
    "ุฏูุจุงูู", "ุฏุงุฑ", "ุดูุงุจ", "ุณูฺฏ", "ุตูุฑุช", "ููฺฉ", "ุชูุณฺฉููพ", "ุฑุตุฏุฎุงูู", "ูุฒฺฉุฏุงู", "ุดูุฏุงู", "ุฒุณุช", "ุดูุงุณ", "ุฑุงุถุงุช", "ููุฏุณู", "ุฌุจุฑ", "ูุซูุซุงุช", "ุญุณุงุจุงู", "ุฏูุฑุงูุณู", "ุงูุชฺฏุฑุงู", "ุขูุงุฑ", 
    "ุงุญุชูุงู", "ูุงุชุฑุณ", "ุจุฑุฏุงุฑ", "ุงููุฏุณ", "ูุซุงุบูุฑุณ", "ุฎูุงุฑุฒู", "ุงุจู", "ุณูุง", "ุฑุงุฒ", "ุจุฑูู", "ุนูุตุฑ", "ุฌุฏูู", "ุชูุงูุจ", "ุงุชู", "ูููฺฉูู", "ูู", "ุงุฒูุชููพ", "ูุงฺฉูุด", "ุดูุง", "ฺฉุงุชุงูุฒูุฑ", 
    "ุขูุฒู", "ูพุฑูุชุฆู", "ฺฉุฑุจููุฏุฑุงุช", "ููพุฏ", "ูุชุงูู", "ูุงุฏู", "ูุนุฏู", "ุฏ", "ุงู", "ุง", "ฺู", "ฺฉุฑูููุฒูู", "ุฌูุด", "ุชฺฉุงูู", "ุฏุงุฑูู", "ูุงูุงุฑฺฉ", "ูุญุท", "ุฒุณุช", "ุงฺฉูุณุณุชู", "ุขููุฏฺฏ", "ฺฏุฑูุงุด", 
    "ุฌูุงู", "ุจุงุฒุงูุช", "ุงูุฑฺ", "ุชุฌุฏุฏูพุฐุฑ", "ุฎูุฑุดุฏ", "ุจุงุฏ", "ุจุฑู", "ุขุจ", "ุฒูู", "ฺฏุฑูุง", "ุฌูฺฏู", "ุจุงุจุงู", "ุงูุงููุณ", "ุฏุฑุง", "ุฑูุฏุฎุงูู", "ุฏุฑุงฺู", "ฺฉููุณุชุงู", "ุขุชุดูุดุงู", "ุฒูุฒูู", "ุณููุงู", 
    "ุทููุงู", "ฺฏุฑุฏุจุงุฏ", "ุฎุดฺฉุณุงู", "ุณู", "ูุงุฑู", "ุขุณุง", "ุงุฑููพุง", "ุขูุฑูุง", "ุขูุฑฺฉุง", "ุงูุงููุณู", "ูุทุจ", "ุดูุงู", "ุฌููุจ", "ุงุณุชูุง", "ูุตู", "ุงูููุงุฑ", "ูุฏุงุฑ", "ุฌุบุฑุงูุง", "ููุดู", "ูุทุจ", "ููุง", 
    "ุชูุฏู", "ูุตุฑ", "ููุงู", "ุฑูู", "ุงุฑุงู", "ฺู", "ููุฏ", "ุจู", "ุงูููุฑู", "ุณููุฑ", "ุจุงุจู", "ุขุดูุฑ", "ูุฎุงููุดุงู", "ุงุดฺฉุงูุงู", "ุณุงุณุงูุงู", "ุงุณูุงู", "ูุบูู", "ุตููู", "ูุงุฌุงุฑ", "ูพููู", "ุฌูููุฑ", 
    "ุงุณูุงู", "ุงุณุทูุฑู", "ุงูุณุงูู", "ุญูุงุณู", "ุฑุณุชู", "ุณูุฑุงุจ", "ุงุณููุฏุงุฑ", "ุณูุฑุบ", "ุถุญุงฺฉ", "ฺฉุงูู", "ุขููฺฏุฑ", "ฺฏูฺฏูุด", "ูุฑฺฉูู", "ุฒุฆูุณ", "ุขูพููู", "ูพูุฒุฏูู", "ูุฑูุณ", "ุขูุฑูุฏุช", "ุฌุดููุงุฑู", "ฺฉุงุฑูุงูุงู", 
    "ูุณุชูุงู", "ุงูููพฺฉ", "ุฌุงู", "ุฌูุงู", "ููุชุจุงู", "ุจุณฺฉุชุจุงู", "ูุงูุจุงู", "ฺฉุดุช", "ูุฒูู", "ุจุฑุฏุงุฑ", "ุฏู", "ูุฏุงู", "ุดูุง", "ฺููุงุณุชฺฉ", "ูุฑุฒุดฺฏุงู", "ุงุณุชุงุฏูู", "ููุฑูุงู", "ูุฏุงู", "ุทูุง", "ููุฑู", "ุจุฑูุฒ", 
    "ุฑฺฉูุฑุฏ", "ูพุงุชุฎุช", "ุชูุฑุงู", "ูพุงุฑุณ", "ููุฏู", "ุฑู", "ูููุฑฺฉ", "ุชูฺฉู", "ูพฺฉู", "ูุณฺฉู", "ุจุฑูู", "ูุงุฏุฑุฏ", "ูุงูุฑู", "ุงุณุชุงูุจูู", "ุณุฏู", "ุชูุฑูุชู", "ุฏุจ", "ุฑุงุถ", "ุฏูุญู", "ูพุงุฏุดุงู", "ููฺฉู", 
    "ุดุงูุฒุงุฏู", "ุฑุฆุณ", "ุฌูููุฑ", "ูุฎุณุช", "ูุฒุฑ", "ุณูุฑ", "ุฏูพููุงุช", "ุฏูพููุงุณ", "ูุฐุงฺฉุฑู", "ูุฑุงุฑุฏุงุฏ", "ูพูุงู", "ุตูุญ", "ุขุชุด", "ุจุณ", "ุงุฑุชุด", "ุณูพุงู", "ูุฑู", "ููุง", "ุฏุฑุง", "ุฒูู", "ุณุฑุจุงุฒ", 
    "ุงูุณุฑ", "ฺูุฑุงู", "ูุฑูุงูุฏู", "ุฌูฺฏ", "ูุจุฑุฏ", "ุนููุงุช", "ุงุณุชุฑุงุชฺ", "ุชุงฺฉุชฺฉ", "ุณูุงุญ", "ููุดฺฉ", "ุชุงูฺฉ", "ููุงูพูุง", "ูุงู", "ุฒุฑุฏุฑุง", "ุฌุงุณูุณ", "ุงุทูุงุนุงุช", "ูพุฑููพุงฺฏุงูุฏุง", "ุณุงูุณูุฑ", "ุขุฒุงุฏ", 
    "ุจุงู", "ุญููู", "ุจุดุฑ", "ุดูุฑููุฏ", "ููุงุฌุฑุช", "ูพูุงููุฏู", "ูุฑุฒ", "ฺฏุฐุฑูุงูู", "ูุฒุง", "ุฌูุงูฺฏุฑุฏ", "ุชูุฑุณู", "ูุชู", "ุฑุณุชูุฑุงู", "ูุฑูุฏฺฏุงู", "ุจูุฏุฑ", "ุงุณุชฺฏุงู", "ูุทุงุฑ", "ุงุชูุจูุณ", "ุชุงฺฉุณ", "ูุชุฑู", 
    "ุจุฒุฑฺฏุฑุงู", "ุฎุงุจุงู", "ฺฉูฺู", "ูุฏุงู", "ฺูุงุฑุฑุงู", "ฺุฑุงุบ", "ุฑุงูููุง", "ูพู", "ุชููู", "ุณุงุฎุชูุงู", "ุขุณูุงู", "ุฎุฑุงุด", "ุจุฑุฌ", "ุขูพุงุฑุชูุงู", "ููุง", "ฺฉูุจู", "ูุตุฑ", "ููุนู", "ููุฒู", "ฺฏุงูุฑ", "ฺฉุชุงุจูุฑูุด", 
    "ฺฉูุณุฑุช", "ุงูพุฑุง", "ุจุงูู", "ููุงุดฺฏุงู", "ุจุงุบ", "ูุญุด", "ูพุงุฑฺฉ", "ุฌูฺฏู", "ุณุงุญู", "ูพูุงฺ", "ุงุณฺฉูู", "ูุงู", "ฺฉุดุช", "ููุฌ", "ุฌุช", "ุงุณฺฉ", "ุบูุงุต", "ููุฌ", "ุณูุงุฑ", "ุงุณฺฉ", "ุงุณููุจุฑุฏ", "ฺฉููููุฑุฏ", 
    "ุตุฎุฑู", "ููุฑุฏ", "ุทุจุนุช", "ฺฏุฑุฏ", "ูููุจุฑุฏุงุฑ", "ุฎูุดููุณ", "ุณูุงูฺฏุฑ", "ุฌูุงูุฑุณุงุฒ", "ุฎุงุท", "ฺฏูุฏูุฒ", "ุจุงูุชู", "ุขุดูพุฒ", "ุดุฑู", "ูพุฒ", "ูุงููุง", "ููุงุฏ", "ฺฉุงูู", "ูููู", "ฺุง", "ููุดุฏู", 
    "ุตุจุญุงูู", "ูุงูุงุฑ", "ุดุงู", "ุฏุณุฑ", "ูพุด", "ุบุฐุง", "ุณุงูุงุฏ", "ุณููพ", "ฺฉุจุงุจ", "ูพุชุฒุง", "ุณุงูุฏูฺ", "ูพุงุณุชุง", "ุจุฑูุฌ", "ุฎูุฑุด", "ุณุจุฒุฌุงุช", "ููู", "ุฎุดฺฉุจุงุฑ", "ุขุฌู", "ุงุฏูู", "ุฒุนูุฑุงู", "ูู", "ุฏุงุฑฺู", 
    "ุฒูุฌุจู", "ูููู", "ููฺฉ", "ุดฺฉุฑ", "ุนุณู", "ูุฑุจุง", "ุดฺฉูุงุช", "ุจุณุชู", "ฺฉฺฉ", "ุดุฑู", "ุจูุงุฑุณุชุงู", "ุฏุฑูุงูฺฏุงู", "ูุทุจ", "ุฏุงุฑูุฎุงูู", "ูพุฒุดฺฉ", "ูพุฑุณุชุงุฑ", "ุฌุฑุงุญ", "ูุชุฎุตุต", "ุฏูุฏุงููพุฒุดฺฉ", "ฺุดู", "ูพุฒุดฺฉ", 
    "ุฏุงุฑูุณุงุฒ", "ุขูุจููุงูุณ", "ุงูุฑฺุงูุณ", "ุจูุงุฑ", "ุณูุงูุช", "ุฏุฑูุงู", "ูุงฺฉุณู", "ุขูุช", "ุจูุชฺฉ", "ูุฑุต", "ุดุฑุจุช", "ุขููพูู", "ุณุฑู", "ุขุฒูุงุดฺฏุงู", "ุฑุงุฏูููฺ", "ุณูููฺฏุฑุงู", "ุณ", "ุช", "ุงุณฺฉู", "ุงู", "ุขุฑ", "ุข", 
    "ูุฏุฑุณู", "ุฏุจุฑุณุชุงู", "ููุฑุณุชุงู", "ฺฉุงูุฌ", "ุขููุฒุดฺฏุงู", "ุฒุจุงู", "ูุนูู", "ุฏุจุฑ", "ุงุณุชุงุฏ", "ุฏุงูุด", "ุขููุฒ", "ุฏุงูุดุฌู", "ฺฉูุงุณ", "ุฏุฑุณ", "ุงูุชุญุงู", "ฺฉูฺฉูุฑ", "ูพุงุงู", "ูุงูู", "ุฑุณุงูู", "ุฏฺฉุชุฑุง", "ฺฉุงุฑุดูุงุณ", 
    "ุงุฑุดุฏ", "ูุณุงูุณ", "ุฏูพูู", "ุชุญุตูุงุช", "ูพฺููุด", "ููุงูู", "ุนูู", "ูุฌูู", "ฺฉููุฑุงูุณ", "ุณููุงุฑ", "ฺฉุงุฑฺฏุงู", "ุขููุฒุด", "ุดุฑฺฉุช", "ฺฉุงุฑุฎุงูู", "ุงุฏุงุฑู", "ุณุงุฒูุงู", "ููุณุณู", "ุจูุงุฏ", "ุงูุฌูู", "ุงุชุญุงุฏู", 
    "ุณูุฏฺฉุง", "ูุฏุฑ", "ฺฉุงุฑููุฏ", "ฺฉุงุฑฺฏุฑ", "ฺฉุงุฑุดูุงุณ", "ูุดุงูุฑ", "ุชุญููฺฏุฑ", "ุญุณุงุจุฏุงุฑ", "ูฺฉู", "ูุงุถ", "ุฏุงุฏฺฏุงู", "ุฏุงุฏุณุฑุง", "ุฒูุฏุงู", "ูพูุณ", "ุขฺฏุงู", "ุฌุฑู", "ุฌูุงุช", "ูุชูู", "ุดุงฺฉ", "ุดุงูุฏ", "ูุฌุงุฒุงุช", 
    "ุฌุฑูู", "ุญุจุณ", "ุงุนุฏุงู", "ุฎุงููุงุฏู", "ูพุฏุฑ", "ูุงุฏุฑ", "ูุฑุฒูุฏ", "ุจุฑุงุฏุฑ", "ุฎูุงูุฑ", "ูพุฏุฑุจุฒุฑฺฏ", "ูุงุฏุฑุจุฒุฑฺฏ", "ููู", "ุนูู", "ุนูู", "ุฏุง", "ุฎุงูู", "ุงุฒุฏูุงุฌ", "ุทูุงู", "ุชููุฏ", "ูุฑฺฏ", "ุนุฑูุณ", "ุนุฒุงุฏุงุฑ", 
    "ุฌุดู", "ูููุงู", "ุฏูุณุช", "ุฑูู", "ููฺฉุงุฑ", "ููุณุงู", "ุนุดู", "ููุฑุช", "ุดุงุฏ", "ุบู", "ุฎุดู", "ุชุฑุณ", "ุงูุฏ", "ูุงุงูุฏ", "ุงุนุชูุงุฏ", "ุฎุงูุช", "ุดุฌุงุนุช", "ุจุฒุฏู", "ุตุฏุงูุช", "ุฏุฑูุบ", "ุนุฏุงูุช", "ุจ", 
    "ุนุฏุงูุช", "ุขุฑุงูุด", "ุงุณุชุฑุณ", "ููููุช", "ุดฺฉุณุช", "ุซุฑูุช", "ููุฑ", "ูุฏุฑุช", "ุถุนู", "ุฒุจุง", "ุฒุดุช", "ุฌูุงู", "ูพุฑ", "ฺฉูุฏฺฉ", "ููุฌูุงู", "ุจุฒุฑฺฏุณุงู", "ุฎุงุทุฑู", "ุฑูุง", "ุขุฑุฒู", "ูุฏู", "ุจุฑูุงูู", "ุฑุฒ", 
    "ุขูุฏู", "ฺฏุฐุดุชู", "ุญุงู", "ุฒูุงู", "ุณุงุนุช", "ุฏููู", "ุซุงูู", "ุฑูุฒ", "ููุชู", "ูุงู", "ุณุงู", "ูุฑู", "ุฏูู", "ุชููู", "ูุตู", "ุจูุงุฑ", "ุชุงุจุณุชุงู", "ูพุงุฒ", "ุฒูุณุชุงู", "ุขุจ", "ููุง", "ุขูุชุงุจ", "ุงุจุฑ", "ุจุงุฑุงู", 
    "ุจุฑู", "ุจุงุฏ", "ูู", "ุฑุนุฏ", "ุจุฑู", "ุฑูฺฏู", "ฺฉูุงู", "ุฑูฺฏ", "ูุฑูุฒ", "ุขุจ", "ุฒุฑุฏ", "ุณุจุฒ", "ูุงุฑูุฌ", "ุจููุด", "ุตูุฑุช", "ูููู", "ุง", "ุณุงู", "ุณูุฏ", "ุฎุงฺฉุณุชุฑ", "ุทูุง", "ููุฑู", "ูุณ", "ุขูู", "ุขูููููู", 
    "ูููุงุฏ", "ูพูุงุณุชฺฉ", "ุดุดู", "ฺูุจ", "ุณูฺฏ", "ูพุงุฑฺู", "ูุจุงุณ", "ูพูุดุงฺฉ", "ฺฉูุด", "ฺฉู", "ฺฉูุงู", "ุนูฺฉ", "ุฌูุงูุฑุงุช", "ุนุทุฑ", "ุงุฏฺฉูู", "ููุงุฒู", "ุขุฑุงุด", "ุจูุฏุงุดุช", "ุดุงููพู", "ุตุงุจูู", "ุฎูุฑ", "ุฏูุฏุงู", 
    "ูุณูุงฺฉ", "ุญููู", "ุฎุงูู", "ุขุดูพุฒุฎุงูู", "ุงุชุงู", "ุฎูุงุจ", "ูพุฐุฑุง", "ุญูุงู", "ุฏุณุชุดู", "ูุจููุงู", "ูุฑุด", "ูพุฑุฏู", "ููุณุชุฑ", "ุชููุฒูู", "ุฎฺุงู", "ุงุฌุงู", "ฺฏุงุฒ", "ูุงุดู", "ูุจุงุณุดู", "ุธุฑูุดู", 
    "ูุงฺฉุฑููู", "ุฌุงุฑูุจุฑู", "ุชููู", "ููุฑุงู", "ุชุจูุช", "ููพุชุงูพ", "ุฏูุฑุจู", "ุจููุฏฺฏู", "ูุฏููู", "ฺฉุชุงุจ", "ุฏูุชุฑ", "ุฎูุฏฺฉุงุฑ", "ูุฏุงุฏ", "ูพุงฺฉ", "ฺฉู", "ุชุฑุงุด", "ุฎุท", "ฺฉุด", "ูพุฑฺฏุงุฑ", "ฺฉุงุบุฐ", "ูููุง", "ฺุณุจ", "ูฺ", "ููฺฏูู", "ุฑูุฒูุงูู"
]
TYPING_SENTENCES = [
    "ุฏุฑ ฺฉ ุฏูฺฉุฏู ฺฉูฺฺฉ ูุฑุฏ ุฒูุฏฺฏ ูฺฉุฑุฏ ฺฉู ุจู ุดุฌุงุนุช ู ุฏุงูุง ูุดููุฑ ุจูุฏ", "ููุงูุฑ ุจูุงฺฉฺู ูพุชุงูุณู ุงุฌุงุฏ ุชุญูู ุฏุฑ ุตูุงุน ูุฎุชูู ุฑุง ุฏุงุฑุฏ", 
    "ุงุฏฺฏุฑ ฺฉ ุฒุจุงู ุจุฑูุงูู ููุณ ุฌุฏุฏ ูุชูุงูุฏ ุฏุฑูุง ุฌุฏุฏ ุจู ุฑู ุดูุง ุจุงุฒ ฺฉูุฏ", "ฺฉุชุงุจ ุฎูุงูุฏู ุจูุชุฑู ุฑุงู ุจุฑุง ุณูุฑ ุจู ุฏูุงูุง ุฏฺฏุฑ ุจุฏูู ุชุฑฺฉ ฺฉุฑุฏู ุฎุงูู ุงุณุช", 
    "ุดุจ ูุง ูพุฑุณุชุงุฑู ฺฉูุฑ ููุธุฑู ุง ูุฑุงููุด ูุดุฏู ุฑุง ุจู ููุงุด ูฺฏุฐุงุฑูุฏ", "ุชู ูุง ุจุฑุง ุฑุณุฏู ุจู ุงู ููููุช ุชูุงุด ูุง ุดุจุงูู ุฑูุฒ ุฒุงุฏ ุงูุฌุงู ุฏุงุฏ", 
    "ุญูุธ ูุญุท ุฒุณุช ูุธูู ุชฺฉ ุชฺฉ ูุง ุจุฑุง ูุณู ูุง ุขูุฏู ุงุณุช", "ููููุช ุฏุฑ ุฒูุฏฺฏ ูุงุฒููุฏ ุชูุงุด ูพุดุชฺฉุงุฑ ู ฺฉู ุดุงูุณ ุงุณุช", 
    "ุงูุชุฑูุช ุงุดุงุก ุฏูุง ุฑุง ูุชุตูุฑ ูุดูุฏ ฺฉู ููู ฺุฒ ุจู ูู ูุชุตู ุงุณุช", "ุจุฒุฑฺฏุชุฑู ูุงุฌุฑุงุฌู ฺฉู ูุชูุงู ุฏุงุดุชู ุจุงุด ุฒูุฏฺฏ ฺฉุฑุฏู ุฑูุงูุงุช ุงุณุช", 
    "ุจุฑุง ุญู ูุณุงุฆู ูพฺุฏู ฺฏุงู ุจุงุฏ ุงุฒ ุฒูุงุง ูุฎุชูู ุจู ุขููุง ูฺฏุงู ฺฉุฑุฏ", "ุชุงุฑุฎ ูพุฑ ุงุฒ ุฏุฑุณ ูุง ุงุณุช ฺฉู ูุชูุงูู ุจุฑุง ุณุงุฎุชู ุขูุฏู ุง ุจูุชุฑ ุงุฒ ุขููุง ุจุงููุฒู", 
    "ููุด ูุตููุน ุจู ุณุฑุนุช ุฏุฑ ุญุงู ุชุบุฑ ฺูุฑู ุฌูุงู ูุง ุงุณุช", "ฺฉ ุฏูุณุช ุฎูุจ ฺฏูุฌ ฺฏุฑุงูุจูุง ุฏุฑ ูุฑุงุฒ ู ูุดุจ ูุง ุฒูุฏฺฏ ุงุณุช", "ุณูุฑ ฺฉุฑุฏู ุจู ููุงุท ูุฎุชูู ุฌูุงู ุฏุฏฺฏุงู ุงูุณุงู ุฑุง ฺฏุณุชุฑุด ูุฏูุฏ", 
    "ูุฑุฒุด ููุธู ฺฉูุฏ ุงุตู ุจุฑุง ุฏุงุดุชู ุจุฏู ุณุงูู ู ุฑูุญ ุดุงุฏุงุจ ุงุณุช", "ููุณู ุฒุจุงู ูุดุชุฑฺฉ ุชูุงู ุงูุณุงู ูุง ุฏุฑ ุณุฑุงุณุฑ ฺฉุฑู ุฒูู ุงุณุช", 
    "ูฺฺฏุงู ุจุฑุง ุงุฏฺฏุฑ ู ุดุฑูุน ฺฉ ูุณุฑ ุฌุฏุฏ ุฏุฑ ูุณุช", "ุงุญุชุฑุงู ุจู ุนูุงุฏ ุฏฺฏุฑุงู ุญุช ุงฺฏุฑ ุจุง ุขููุง ูุฎุงูู ุจุงุดู ูุดุงูู ุจููุบ ุงุณุช", 
    "ุชุบุฑ ุชููุง ูพุฏุฏู ุซุงุจุช ุฏุฑ ุฌูุงู ูุณุช ุงุณุช ุจุงุฏ ุฎูุฏ ุฑุง ุจุง ุขู ููู ุฏูู", "ุตุจุฑ ู ุดฺฉุจุง ุฏุฑ ุจุฑุงุจุฑ ูุดฺฉูุงุช ุขููุง ุฑุง ุฏุฑ ููุงุช ุญู ุดุฏู ูฺฉูุฏ", 
    "ุฎูุงูุช ุนู ุฏุฏู ฺุฒ ฺฉู ุฏฺฏุฑุงู ููุจููุฏ ู ุงูุฌุงู ฺฉุงุฑ ฺฉู ุฏฺฏุฑุงู ุฌุฑุงุชุด ุฑุง ูุฏุงุฑูุฏ", "ุดุงุฏ ูุงูุน ุฏุฑ ุฏุงุดุชู ฺุฒูุง ุฒุงุฏ ูุณุช ุจูฺฉู ุฏุฑ ูุฐุช ุจุฑุฏู ุงุฒ ฺุฒูุง ุงุณุช ฺฉู ุฏุงุฑู", 
    "ุตุฏุงูุช ู ุฑุงุณุชฺฏู ุณูฺฏ ุจูุง ูุฑ ุฑุงุจุทู ูพุงุฏุงุฑ ู ูููู ุงุณุช", "ฺฉูฺฉุดุงู ุฑุงู ุดุฑ ุชููุง ฺฉ ุงุฒ ููุงุฑุฏูุง ฺฉูฺฉุดุงู ููุฌูุฏ ุฏุฑ ฺฉูุงู ุงุณุช", 
    "ุจุฑุง ุณุงุฎุชู ฺฉ ุฑุจุงุช ูพุดุฑูุชู ุจู ุฏุงูุด ุจุฑูุงูู ููุณ ู ุงูฺฉุชุฑููฺฉ ูุงุฒ ุงุณุช", "ุงููุช ุณุงุจุฑ ุฏุฑ ุฏูุง ุฏุฌุชุงู ุงูุฑูุฒ ุงุฒ ุงููุช ููู ุงูุนุงุฏู ุง ุจุฑุฎูุฑุฏุงุฑ ุงุณุช", 
    "ูุฑฺฏุฒ ูุฏุฑุช ฺฉ ุงุฏู ุฎูุจ ุฑุง ุฏุณุช ฺฉู ูฺฏุฑ ูุชูุงูุฏ ุฏูุง ุฑุง ุชุบุฑ ุฏูุฏ", "ฺฉุงุฑ ฺฏุฑูู ู ููฺฉุงุฑ ูุชูุงูุฏ ููุฌุฑ ุจู ูุชุงุฌ ุดฺฏูุช ุงูฺฏุฒ ุดูุฏ", 
    "ุดฺฉุณุช ุจุฎุด ุงุฒ ูุณุฑ ููููุช ุงุณุช ุงุฒ ุขู ุฏุฑุณ ุจฺฏุฑุฏ ู ุฏูุจุงุฑู ุชูุงุด ฺฉูุฏ", "ุฌูฺฏู ูุง ุขูุงุฒูู ุจู ุนููุงู ุฑู ูุง ฺฉุฑู ุฒูู ุดูุงุฎุชู ูุดููุฏ", 
    "ฺฉูู ุงูุฑุณุช ุจููุฏุชุฑู ููู ุฌูุงู ุฏุฑ ุฑุดุชู ฺฉูู ููุงูุง ูุฑุงุฑ ุฏุงุฑุฏ", "ุฏูุงุฑ ุจุฒุฑฺฏ ฺู ฺฉ ุงุฒ ุดฺฏูุช ูุง ุณุงุฎุช ุจุดุฑ ุฏุฑ ุทูู ุชุงุฑุฎ ุงุณุช", 
    "ุงูุฑุงู ุซูุงุซู ูุตุฑ ููุงุฏ ุชูุฏู ุจุงุณุชุงู ู ูุนูุงุฑ ุดฺฏูุช ุงูฺฏุฒ ุขู ุฏูุฑุงู ูุณุชูุฏ", "ุฎูุฑุดุฏ ฺฏุฑูุชฺฏ ุฒูุงู ุฑุฎ ูุฏูุฏ ฺฉู ูุงู ุจู ุฒูู ู ุฎูุฑุดุฏ ูุฑุงุฑ ุจฺฏุฑุฏ", 
    "ุขุจ ูุงู ุญุงุช ุงุณุช ู ุจุงุฏ ุฏุฑ ูุตุฑู ุขู ุตุฑูู ุฌู ฺฉูู", "ุฒูุจูุฑูุง ุนุณู ููุด ุจุณุงุฑ ููู ุฏุฑ ฺฏุฑุฏู ุงูุดุงู ู ุญุงุช ฺฏุงูุงู ุฏุงุฑูุฏ", 
    "ุจุงุฒุงูุช ุฒุจุงูู ุจู ุญูุธ ููุงุจุน ุทุจุน ู ฺฉุงูุด ุขููุฏฺฏ ฺฉูฺฉ ูฺฉูุฏ", "ฺฉูฺฉุดุงู ุขูุฏุฑููุฏุง ูุฒุฏฺฉุชุฑู ฺฉูฺฉุดุงู ูุงุฑูพฺ ุจู ฺฉูฺฉุดุงู ูุง ุงุณุช", 
    "ุณุฑุนุช ููุฑ ุจุงูุงุชุฑู ุณุฑุนุช ููฺฉู ุฏุฑ ุฌูุงู ูุณุช ูุญุณูุจ ูุดูุฏ", "ูุฑ ุงูุณุงู ุฏุงุฑุง ุงุซุฑ ุงูฺฏุดุช ููุญุตุฑ ุจู ูุฑุฏ ุงุณุช ฺฉู ุงู ุฑุง ุงุฒ ุฏฺฏุฑุงู ูุชูุงุฒ ูฺฉูุฏ", 
    "ูุฒูพููฺฏ ุณุฑุนุชุฑู ุญูุงู ุฑู ุฎุดฺฉ ุงุณุช ู ูุชูุงูุฏ ุจู ุณุฑุนุช ุจุงูุง ุจุฑุณุฏ", "ููุจ ฺฉ ุงูุณุงู ุจุงูุบ ุจู ุทูุฑ ูุชูุณุท ุตุฏ ูุฒุงุฑ ุจุงุฑ ุฏุฑ ุฑูุฒ ูุชูพุฏ", 
    "ุฎูุงุจ ฺฉุงู ุจุฑุง ุณูุงูุช ุฌุณู ู ุฑูุงู ู ุนููฺฉุฑุฏ ุจูุชุฑ ูุบุฒ ุถุฑูุฑ ุงุณุช", "ูุชุงูู ุฏ ุจุง ูุฑุงุฑ ฺฏุฑูุชู ุฏุฑ ูุนุฑุถ ููุฑ ุฎูุฑุดุฏ ุฏุฑ ุจุฏู ุชููุฏ ูุดูุฏ", 
    "ุฎูุฏู ุจูุชุฑู ุฏุงุฑู ุจุฑุง ฺฉุงูุด ุงุณุชุฑุณ ู ุชููุช ุณุณุชู ุงูู ุจุฏู ุงุณุช", "ุงุฏฺฏุฑ ููุณู ูุชูุงูุฏ ุจู ุจูุจูุฏ ุญุงูุธู ู ููุงููฺฏ ุงุนุถุง ุจุฏู ฺฉูฺฉ ฺฉูุฏ", 
    "ุงุฑุชุจุงุทุงุช ูุงููุงุฑู ุง ุงูฺฉุงู ุจุฑูุฑุงุฑ ุชูุงุณ ุฏุฑ ุณุฑุงุณุฑ ุฌูุงู ุฑุง ูุฑุงูู ฺฉุฑุฏู ุงุณุช", "ูุจุฑ ููุฑ ุจุง ุงุณุชูุงุฏู ุงุฒ ูพุงูุณ ูุง ููุฑ ุฏุงุฏู ูุง ุฑุง ุจุง ุณุฑุนุช ุจุงูุง ููุชูู ูฺฉูุฏ", 
    "ูุงูุนุช ูุฌุงุฒ ุชุฌุฑุจู ุง ูุฑุงฺฏุฑ ุงุฒ ฺฉ ุฏูุง ุดุจู ุณุงุฒ ุดุฏู ุฑุง ุงุฑุงุฆู ูุฏูุฏ", "ฺุงูพฺฏุฑูุง ุณู ุจุนุฏ ูุงุฏุฑ ุจู ุณุงุฎุช ุงุดุงุก ูุฒฺฉ ุงุฒ ุฑู ูุฏู ูุง ุฏุฌุชุงู ูุณุชูุฏ", 
    "ุฎูุฏุฑููุง ุงูฺฉุชุฑฺฉ ุจุง ูุฏู ฺฉุงูุด ุขููุฏฺฏ ููุง ุฏุฑ ุญุงู ฺฏุณุชุฑุด ูุณุชูุฏ", "ุงูุฑฺ ูุณุชู ุง ุงุฒ ุดฺฉุงูุช ุงุชู ูุง ุจุฑุง ุชููุฏ ุจุฑู ุงุณุชูุงุฏู ูฺฉูุฏ", "ูุทุฑู ูุทุฑู ุฌูุน ฺฏุฑุฏุฏ ูุงูฺฏู ุฏุฑุง ุดูุฏ", 
    "ุขูุฏู ุณุงุฎุชู ุงุณุช ูู ุงูุชู ูพุณ ุจุงุฏ ุจุฑุง ุขู ุชูุงุด ฺฉุฑุฏ", "ุจูุชุฑู ุฒูุงู ุจุฑุง ฺฉุงุดุชู ฺฉ ุฏุฑุฎุช ุจุณุช ุณุงู ูพุด ุจูุฏ ุฒูุงู ุจุนุฏ ููู ุงูุฑูุฒ ุงุณุช", 
    "ุจุฑุง ุฏุฏู ุฑูฺฏู ฺฉูุงู ุจุงุฏ ูู ุจุงุฑุงู ุฑุง ุชุญูู ฺฉู ูู ุขูุชุงุจ ุฑุง", "ููููุช ูุฌููุนู ุง ุงุฒ ุชูุงุด ูุง ฺฉูฺฺฉ ุงุณุช ฺฉู ูุฑ ุฑูุฒ ุชฺฉุฑุงุฑ ูุดููุฏ", 
    "ุชููุง ูุญุฏูุฏุช ูุง ุฒูุฏฺฏ ุขููุง ูุณุชูุฏ ฺฉู ุฎูุฏูุงู ุจุฑุง ุฎูุฏูุงู ุงุฌุงุฏ ูฺฉูู", "ุจู ุฌุง ูฺฏุฑุงู ุฏุฑ ููุฑุฏ ฺุฒูุง ฺฉู ููุชูุงู ฺฉูุชุฑู ฺฉู ุฑู ฺุฒูุง ฺฉู ูุชูุงู ุชุบุฑ ุฏู ุชูุฑฺฉุฒ ฺฉู", 
    "ุดุฌุงุนุช ูุจูุฏู ุชุฑุณ ูุณุช ุจูฺฉู ุนูู ฺฉุฑุฏู ุจุง ูุฌูุฏ ุชุฑุณ ุงุณุช", "ฺฉ ุณูุฑ ูุฒุงุฑ ฺฉูููุชุฑ ุจุง ุงููู ูุฏู ุขุบุงุฒ ูุดูุฏ", "ุฒูุฏฺฏ ูุซู ุฏูฺุฑุฎู ุณูุงุฑ ุงุณุช ุจุฑุง ุญูุธ ุชุนุงุฏู ุจุงุฏ ุจู ุญุฑฺฉุช ุงุฏุงูู ุฏู", 
    "ุงูุณุงู ูุง ูููู ููุดู ุจู ุฏูุจุงู ูุฑุตุช ูุง ุจุฑุง ฺฉูฺฉ ุจู ุฏฺฏุฑุงู ูุณุชูุฏ", "ูุฏู ฺฏุฐุงุฑ ุงููู ูุฏู ุจุฑุง ุชุจุฏู ูุงุฏุฏู ูุง ุจู ุฏุฏู ูุง ุงุณุช", 
    "ุฑุงุฒ ูพุดุฑูุช ุดุฑูุน ฺฉุฑุฏู ุงุณุช ูพุณ ููุชุธุฑ ุฒูุงู ููุงุณุจ ููุงู", "ุงฺฏุฑ ูุฎูุงู ูุชูุงูุช ุจุงุด ุจุงุฏ ฺฉุงุฑูุง ูุชูุงูุช ุงูุฌุงู ุฏู", "ุงุดุชุจุงู ฺฉุฑุฏู ุจุฎุด ุงุฒ ุงูุณุงู ุจูุฏู ุงุณุช ููู ุฏุฑุณ ฺฏุฑูุชู ุงุฒ ุขููุง ุงุณุช", 
    "ุงุฌุงุฒู ูุฏู ุณุฑ ู ุตุฏุง ุนูุงุฏ ุฏฺฏุฑุงู ุตุฏุง ุฏุฑูู ุชู ุฑุง ุฎุงููุด ฺฉูุฏ", "ุฎูุดุจุฎุช ฺฉ ูุณุฑ ุงุณุช ูู ฺฉ ููุตุฏ ุงุฒ ูุญุธุงุช ุฎูุฏ ูุฐุช ุจุจุฑ", 
    "ุชููุง ุฑุงู ุงูุฌุงู ุฏุงุฏู ฺฉุงุฑูุง ุจุฒุฑฺฏ ุฏูุณุช ุฏุงุดุชู ฺฉุงุฑ ุงุณุช ฺฉู ุงูุฌุงู ูุฏู", "ูุฑุตุช ูุง ูุงููุฏ ุทููุน ุฎูุฑุดุฏ ูุณุชูุฏ ุงฺฏุฑ ุฒุงุฏ ุตุจุฑ ฺฉู ุขููุง ุฑุง ุงุฒ ุฏุณุช ูุฏู", 
    "ุงุณุชุนุฏุงุฏ ุฐุงุช ููุท ฺฉ ุดุฑูุน ุงุณุช ุจุงุฏ ุจุง ุชูุงุด ุขู ุฑุง ูพุฑูุฑุด ุฏู", "ุจุง ุงูฺฉุงุฑ ูุซุจุช ุฏูุง ุฎูุฏ ุฑุง ุฒุจุงุชุฑ ฺฉู ฺูู ุฒูุฏฺฏ ุงูุนฺฉุงุณ ุงูฺฉุงุฑ ุชู ุงุณุช", 
    "ุจุฑุง ุฑุณุฏู ุจู ููู ุจุงุฏ ุณุฎุช ูุง ูุณุฑ ุฑุง ุชุญูู ฺฉุฑุฏ", "ุณฺฉูุช ฺฏุงู ุจูุชุฑู ูพุงุณุฎ ุจู ุณูุงูุงุช ุจ ูุนู ุงุณุช", "ุจุฑุง ุฏุงุดุชู ุฏูุณุช ููุงุฏุงุฑ ุจุงุฏ ุฎูุฏุช ฺฉ ุฏูุณุช ููุงุฏุงุฑ ุจุงุด", 
    "ุงูุฏ ูุงููุฏ ฺุฑุงุบ ุฏุฑ ุชุงุฑฺฉ ูุณุฑ ุฑุง ุจุฑุงุช ุฑูุดู ูฺฉูุฏ", "ฺฉุชุงุจ ูุง ุจูุชุฑู ุฏูุณุชุงู ุฎุงููุด ูุง ูุณุชูุฏ ฺฉู ูุฑฺฏุฒ ูุง ุฑุง ุชุฑฺฉ ููฺฉููุฏ", 
    "ุฏุงูุด ูุฏุฑุช ุงุณุช ฺฉู ูฺฺฉุณ ููุชูุงูุฏ ุขู ุฑุง ุงุฒ ุชู ุจฺฏุฑุฏ", "ฺฏุฐุดุชู ุฑุง ููุชูุงู ุชุบุฑ ุฏุงุฏ ุงูุง ุขูุฏู ูููุฒ ุฏุฑ ุฏุณุชุงู ุชู ุงุณุช", 
    "ุชูุงูุช ุจู ฺฉ ูุฑุฏ ูููู ู ุฏฺฏุฑุงู ฺฉูุจูุฏ ูุฏุฑุช ูุณุช ุจูฺฉู ฺฉูุจูุฏ ุงุฑุงุฏู ุงุณุช", "ุงูุณุงู ูุง ุจุฒุฑฺฏ ุฏุฑุจุงุฑู ุงุฏู ูุง ุตุญุจุช ูฺฉููุฏ ุงูุณุงู ูุง ูุชูุณุท ุฏุฑุจุงุฑู ุฑูุฏุงุฏูุง ู ุงูุณุงู ูุง ฺฉูฺฺฉ ุฏุฑุจุงุฑู ุฏฺฏุฑุงู", 
    "ุจุฑุง ูพุฑูุงุฒ ฺฉุฑุฏู ูุงุฒู ูุณุช ุญุชูุง ุจุงู ุฏุงุดุชู ุจุงุด ุฏุงุดุชู ุงุฑุงุฏู ู ุฑูุง ฺฉุงู ุงุณุช", "ุณุงุฏู ุชุฑู ฺฉุงุฑูุง ุงุบูุจ ุฏุฑุณุช ุชุฑู ุขููุง ูุณุชูุฏ", 
    "ุชูุฑู ุฒุงุฏ ุจุงุนุซ ูุดูุฏ ฺฉุงุฑูุง ุณุฎุช ุขุณุงู ุจู ูุธุฑ ุจุฑุณูุฏ", "ฺฉ ุฐูู ุขุฑุงู ูุชูุงูุฏ ูู ุชุฑู ุทููุงู ูุง ุฑุง ูพุดุช ุณุฑ ุจฺฏุฐุงุฑุฏ", 
    "ูุฑฺฏุฒ ุงุฌุงุฒู ูุฏู ุฏุฑูุฒ ุจุฎุด ุฒุงุฏ ุงุฒ ุงูุฑูุฒ ุชู ุฑุง ุจู ุฎูุฏ ุงุฎุชุตุงุต ุฏูุฏ", "ุงฺฏุฑ ุจู ุฏูุจุงู ูุชุงุฌ ูุชูุงูุช ูุณุช ุจุงุฏ ุฑูุด ูุง ูุชูุงูุช ุฑุง ุงูุชุญุงู ฺฉู", 
    "ุตุจุฑ ฺฉูุฏ ููููุช ุฏุฑ ุชูุงู ูุฑุงุญู ุฒูุฏฺฏ ุงุณุช", "ุณุน ูฺฉู ุงูุณุงู ูููู ุจุงุด ุจูฺฉู ุณุน ฺฉู ุงูุณุงู ุจุง ุงุฑุฒุด ุจุงุด", "ุฑุงุฒ ุดุงุฏ ุฒุณุชู ุฏุฑ ูุฐุช ุจุฑุฏู ุงุฒ ฺุฒูุง ฺฉูฺฺฉ ุงุณุช", 
    "ููุดู ุจู ุงุฏ ุฏุงุดุชู ุจุงุด ฺฉู ูุณุฑ ููููุช ุฏุฑ ุญุงู ุณุงุฎุช ุงุณุช ูู ฺฉ ุฌุงุฏู ุขูุงุฏู", "ฺฉ ูุจุฎูุฏ ูุชูุงูุฏ ุดุฑูุน ฺฉ ุฏูุณุช ุฒุจุง ุจุงุดุฏ", 
    "ุงฺฏุฑ ูุฎูุงู ุฏูุง ุฑุง ุชุบุฑ ุฏู ุงุฒ ูุฑุชุจ ฺฉุฑุฏู ุชุฎุช ุฎูุฏุช ุดุฑูุน ฺฉู", "ุจุฎุดุฏู ุฏฺฏุฑุงู ุจู ูุนูุง ูุฑุงููุด ฺฉุฑุฏู ฺฏุฐุดุชู ูุณุช ุจูฺฉู ุจู ูุนูุง ุณุงุฎุชู ุขูุฏู ุง ุจูุชุฑ ุงุณุช", 
    "ููุฑุจุงู ุฒุจุงู ุงุณุช ฺฉู ูุงุดููุงุงู ูุชูุงููุฏ ุจุดูููุฏ ู ูุงุจูุงุงู ูุชูุงููุฏ ุจุจููุฏ", "ูุฑ ุฑูุฒ ฺฉ ูุฑุตุช ุฌุฏุฏ ุจุฑุง ุดุฑูุน ุฏูุจุงุฑู ู ุจูุชุฑ ุดุฏู ุงุณุช", 
    "ุณุน ูฺฉู ุฏุฑ ุจุฑุงุจุฑ ุทููุงู ููุงููุช ฺฉู ุงุฏ ุจฺฏุฑ ุฏุฑ ุจุงุฑุงู ุจุฑูุต", "ุฒูุฏฺฏ ฺฉ ุจูู ููุงุด ุงุณุช ุณุน ฺฉู ุขู ุฑุง ุจุง ุฑูฺฏ ูุง ุดุงุฏ ุฑูฺฏ ุขูุฒ ฺฉู", 
    "ุงฺฏุฑ ุจุชูุงู ฺุฒ ุฑุง ุฑูุงูพุฑุฏุงุฒ ฺฉู ูพุณ ุญุชูุง ูุชูุงู ุขู ุฑุง ุงูุฌุงู ุฏู", "ููู ูุณุช ฺูุฏุฑ ุขูุณุชู ุญุฑฺฉุช ูฺฉู ุชุง ุฒูุงู ฺฉู ูุชููู ูุดู ูพุดุฑูุช ุฎูุงู ฺฉุฑุฏ", 
    "ฺฉ ุดูุน ูุชูุงูุฏ ูุฒุงุฑุงู ุดูุน ุฏฺฏุฑ ุฑุง ุฑูุดู ฺฉูุฏ ุจุฏูู ุขูฺฉู ุงุฒ ุนูุฑุด ฺฉุงุณุชู ุดูุฏ", "ุดุงุฏ ุฒูุงู ุฏูฺูุฏุงู ูุดูุฏ ฺฉู ุขู ุฑุง ุจุง ุฏฺฏุฑุงู ุชูุณู ฺฉู", 
    "ุจูุชุฑู ุฑุงู ุจุฑุง ูพุด ุจู ุขูุฏู ุณุงุฎุชู ุขู ุงุณุช", "ูุฑฺฏุฒ ุจุฑุง ุชุจุฏู ุดุฏู ุจู ุขู ฺฉุณ ฺฉู ูุชูุงูุณุช ุจุงุด ุฏุฑ ูุณุช", 
    "ุฐูู ุงูุณุงู ูุงููุฏ ฺฉ ุจุงุบ ุงุณุช ูุฑฺู ุฏุฑ ุขู ุจฺฉุงุฑ ููุงู ุฑุง ุฏุฑู ูฺฉู", "ฺฉ ฺฏูุชฺฏู ุตุงุฏูุงูู ูุชูุงูุฏ ุจุณุงุฑ ุงุฒ ูุดฺฉูุงุช ุฑุง ุญู ฺฉูุฏ", 
    "ุณุฎุงูุช ุนู ุจุฎุดุฏู ุจุด ุงุฒ ุชูุงูุง ุงุช ู ุบุฑูุฑ ุนู ฺฏุฑูุชู ฺฉูุชุฑ ุงุฒ ูุงุฒุช", "ฺฉุณุงู ฺฉู ุจู ุงูุฏุงุฒู ฺฉุงู ุฏูุงูู ูุณุชูุฏ ฺฉู ูฺฉุฑ ฺฉููุฏ ูุชูุงููุฏ ุฏูุง ุฑุง ุชุบุฑ ุฏููุฏ ููุงู ูุง ูุณุชูุฏ ฺฉู ุงู ฺฉุงุฑ ุฑุง ูฺฉููุฏ", 
    "ุงูุชูุงู ฺฏุฑูุชู ุชู ุฑุง ุจุง ุฏุดููุช ุจุฑุงุจุฑ ูฺฉูุฏ ุงูุง ุจุฎุดุฏู ุงู ุชู ุฑุง ุจุฑุชุฑ ุงุฒ ุงู ูุฑุงุฑ ูุฏูุฏ", "ฺฉุณ ฺฉู ุณูุงู ููพุฑุณุฏ ุจุฑุง ฺฉ ุฏููู ูุงุฏุงู ุงุณุช ุงูุง ฺฉุณ ฺฉู ุณูุงู ูููพุฑุณุฏ ุจุฑุง ููุดู ูุงุฏุงู ุจุงู ููุงูุฏ", 
    "ุฒูุฏฺฏ ฺฉูุชุงูุชุฑ ุงุฒ ุขู ุงุณุช ฺฉู ููุช ุฎูุฏ ุฑุง ุตุฑู ูุชููุฑ ุจูุฏู ุงุฒ ุฏฺฏุฑุงู ฺฉู", "ุจุฑุง ุณุงุฎุชู ฺฉ ุฎุงูู ูุญฺฉู ุจุงุฏ ูพุงู ูุง ุขู ุฑุง ูู ุจูุง ฺฉู", 
    "ฺฉ ฺฉุชุงุจ ุฎูุจ ูุชูุงูุฏ ุฏุฏฺฏุงู ุชู ุฑุง ูุณุจุช ุจู ฺฉู ุฏูุง ุชุบุฑ ุฏูุฏ", "ูุฏุฑุช ูุงูุน ุฏุฑ ฺฉูุชุฑู ฺฉุฑุฏู ุฏฺฏุฑุงู ูุณุช ุจูฺฉู ุฏุฑ ฺฉูุชุฑู ฺฉุฑุฏู ุฎูุฏ ุงุณุช", 
    "ูุฑฺฏุฒ ุงุฑุฒุด ฺฉ ูุญุธู ุฑุง ููููู ุชุง ุฒูุงู ฺฉู ุจู ฺฉ ุฎุงุทุฑู ุชุจุฏู ุดูุฏ", "ุจุฑุง ุดูุง ฺฉุฑุฏู ุฏุฑ ุฌูุช ูุฎุงูู ุฑูุฏุฎุงูู ุจุงุฏ ููุชุฑ ุงุฒ ุฌุฑุงู ุขุจ ุจุงุด", 
    "ฺฉ ููุฑูุงู ูุงูุน ฺฉุณ ุงุณุช ฺฉู ุจุง ูุฌูุฏ ุชูุงู ุณุฎุช ูุง ุฏูุจุงุฑู ุจุฑูุฎุฒุฏ", "ุขุฑุงูุด ุฑุง ุฏุฑ ุฏุฑูู ุฎูุฏุช ูพุฏุง ฺฉู ูู ุฏุฑ ุฏูุง ุจุฑูู", 
    "ุงููู ูุฏู ุจุฑุง ุฑุณุฏู ุจู ูุฑ ุฌุง ุชุตูู ฺฏุฑูุชู ุจุฑุง ุญุฑฺฉุช ุงุณุช", "ุงฺฏุฑ ุจู ุฒุจุง ุงุนุชูุงุฏ ุฏุงุดุชู ุจุงุด ุขู ุฑุง ุฏุฑ ููู ุฌุง ุฎูุงู ุฏุฏ", 
    "ูฺ ฺุฒ ุงุฑุฒุดููุฏ ุจู ุขุณุงู ุจู ุฏุณุช ูู ุขุฏ", "ฺฉ ุฏุฑูุบ ููฺฉู ุงุณุช ุจุฑุง ูุฏุช ุชู ุฑุง ูุฌุงุช ุฏูุฏ ุงูุง ุฏุฑ ููุงุช ุญููุช ุขุดฺฉุงุฑ ูุดูุฏ", 
    "ุจุฑุง ุดูุฏู ุตุฏุง ูุฑุตุช ูุง ุจุงุฏ ฺฏูุด ูุงุช ุฑุง ุชุฒ ฺฉู", "ฺฉ ุฑูุจุฑ ูุงูุน ุฑุงู ุฑุง ุจูุฏ ุงุณุช ุฑุงู ุฑุง ูุฑูุฏ ู ุฑุงู ุฑุง ูุดุงู ูุฏูุฏ", 
    "ูุฑฺฏุฒ ุงุฌุงุฒู ูุฏู ููููุช ูุงุช ุชู ุฑุง ูุบุฑูุฑ ู ุดฺฉุณุช ูุงุช ุชู ุฑุง ูุงุงูุฏ ฺฉูุฏ", "ุฒุจุง ูุงูุน ุฏุฑ ุณุงุฏฺฏ ูููุชู ุงุณุช", 
    "ฺฉ ุฏูุณุช ุฎูุจ ุฏุฑ ุฑูุฒูุง ุณุฎุช ูุงููุฏ ุขูู ู ุฏุฑ ุฑูุฒูุง ุฎูุจ ูุงููุฏ ุณุงู ุงุณุช", "ุจุฑุง ุฑุณุฏู ุจู ููุฑ ุจุงุฏ ุงุฒ ุชุงุฑฺฉ ุนุจูุฑ ฺฉุฑุฏ", 
    "ุฏุงูุด ุจุฏูู ุนูู ูุงููุฏ ุงุจุฑ ุจ ุจุงุฑุงู ุงุณุช", "ุฒูุฏฺฏ ฺฉ ุจุงุฒ ุงุณุช ุณุน ฺฉู ุงุฒ ุขู ูุฐุช ุจุจุฑ ู ุฌูุงููุฑุฏุงูู ุจุงุฒ ฺฉู", 
    "ุงุนุชูุงุฏ ูุงููุฏ ฺฉ ฺฉุงุบุฐ ุงุณุช ุงฺฏุฑ ูฺุงูู ุดูุฏ ุฏฺฏุฑ ูุฑฺฏุฒ ุตุงู ูุฎูุงูุฏ ุดุฏ", "ฺฉ ููุจ ููุฑุจุงู ุงุฒ ุชูุงู ูุนุงุจุฏ ู ูุณุงุฌุฏ ุฏูุง ููุฏุณ ุชุฑ ุงุณุช", 
    "ุขูุฏู ูุชุนูู ุจู ฺฉุณุงู ุงุณุช ฺฉู ุจู ุฒุจุง ุฑูุงูุงุดุงู ุงูุงู ุฏุงุฑูุฏ", "ุฌุงุฏู ุงุจุฑุดู ฺฉ ูุณุฑ ุชุฌุงุฑ ุจุงุณุชุงู ุจุฑุง ุงุชุตุงู ุดุฑู ู ุบุฑุจ ุจูุฏ", 
    "ฺฉูู ุฏูุงููุฏ ุจููุฏุชุฑู ููู ุขุชุดูุดุงู ุฏุฑ ุฎุงูุฑูุงูู ุงุณุช", "ุขุฑุด ฺฉูุงูฺฏุฑ ูุฑุฒ ุงุฑุงู ู ุชูุฑุงู ุฑุง ุจุง ูพุฑุชุงุจ ฺฉ ุชุฑ ูุดุฎุต ฺฉุฑุฏ", 
    "ุฎูุฌ ูุงุฑุณ ฺฉ ุงุฒ ูููุชุฑู ุขุจุฑุงู ูุง ุงุณุชุฑุงุชฺฺฉ ุฌูุงู ุจู ุดูุงุฑ ูุฑูุฏ", "ุฑุงุฒ ุชุบุฑ ฺฉุฑุฏู ุฏุฑ ุงู ุงุณุช ฺฉู ุชูุงู ุงูุฑฺ ุฎูุฏ ุฑุง ุฑู ุณุงุฎุชู ุนุงุฏุช ูุง ุฌุฏุฏ ุจฺฏุฐุงุฑ"
]
# --- Logging Setup ---
logging.basicConfig(format="%(asctime)s - %(name)s - %(levelname)s - %(message)s", level=logging.INFO)
logger = logging.getLogger(__name__)

# --- Database Management ---
DATABASE_URL = os.environ.get("DATABASE_URL")
def get_db_connection():
    try: return psycopg2.connect(DATABASE_URL)
    except Exception as e:
        logger.error(f"Database connection failed: {e}")
        return None

def setup_database():
    conn = get_db_connection()
    if conn:
        try:
            with conn.cursor() as cur:
                cur.execute("CREATE TABLE IF NOT EXISTS users (user_id BIGINT PRIMARY KEY, first_name VARCHAR(255), username VARCHAR(255), start_time TIMESTAMP WITH TIME ZONE DEFAULT NOW());")
                cur.execute("CREATE TABLE IF NOT EXISTS groups (group_id BIGINT PRIMARY KEY, title VARCHAR(255), member_count INT, added_time TIMESTAMP WITH TIME ZONE DEFAULT NOW());")
                cur.execute("CREATE TABLE IF NOT EXISTS start_message (id INT PRIMARY KEY, message_id BIGINT, chat_id BIGINT);")
                cur.execute("CREATE TABLE IF NOT EXISTS banned_users (user_id BIGINT PRIMARY KEY);")
                cur.execute("CREATE TABLE IF NOT EXISTS banned_groups (group_id BIGINT PRIMARY KEY);")
                # <<<--- New table for username mapping --->>>
                cur.execute("CREATE TABLE IF NOT EXISTS usernames (user_id BIGINT PRIMARY KEY, username VARCHAR(255) UNIQUE);")
            conn.commit()
            logger.info("Database setup complete.")
        except Exception as e: logger.error(f"Database setup failed: {e}")
        finally: conn.close()

# --- Helper Functions ---
async def is_owner(user_id: int) -> bool: return user_id in OWNER_IDS
async def is_group_admin(user_id: int, chat_id: int, context: ContextTypes.DEFAULT_TYPE) -> bool:
    if await is_owner(user_id): return True
    admins = await context.bot.get_chat_administrators(chat_id)
    return user_id in {admin.user.id for admin in admins}
def convert_persian_to_english_numbers(text: str) -> str:
    if not text: return ""
    return text.translate(str.maketrans("ฐฑฒณดตถทธน", "0123456789"))

# --- Game State Management ---
active_games = {'guess_number': {}, 'dooz': {}, 'hangman': {}, 'typing': {}, 'hokm': {}}
active_gharch_games = {}
# --- Forced Join & Ban Logic ---
async def pre_command_check(update: Update, context: ContextTypes.DEFAULT_TYPE) -> bool:
    user = update.effective_user
    chat = update.effective_chat
    if not user: return False

    # <<<--- Update username in database on interaction --->>>
    if user.username:
        conn = get_db_connection()
        if conn:
            with conn.cursor() as cur:
                cur.execute(
                    "INSERT INTO usernames (user_id, username) VALUES (%s, %s) ON CONFLICT (user_id) DO UPDATE SET username = EXCLUDED.username;",
                    (user.id, user.username.lower())
                )
                conn.commit()
            conn.close()

    conn = get_db_connection()
    if conn:
        with conn.cursor() as cur:
            cur.execute("SELECT 1 FROM banned_users WHERE user_id = %s;", (user.id,))
            if cur.fetchone(): return False
            if chat.type != 'private':
                cur.execute("SELECT 1 FROM banned_groups WHERE group_id = %s;", (chat.id,))
                if cur.fetchone(): 
                    try: await context.bot.leave_chat(chat.id)
                    except: pass
                    return False
        conn.close()
    
    return await force_join_middleware(update, context)

async def force_join_middleware(update: Update, context: ContextTypes.DEFAULT_TYPE) -> bool:
    user = update.effective_user
    if not user: return False
    if await is_owner(user.id): return True
    try:
        member = await context.bot.get_chat_member(chat_id=FORCED_JOIN_CHANNEL, user_id=user.id)
        if member.status in [ChatMemberStatus.MEMBER, ChatMemberStatus.ADMINISTRATOR, ChatMemberStatus.OWNER]: return True
    except Exception as e:
        logger.warning(f"Could not check channel membership for {user.id}: {e}")
    
    keyboard = [[InlineKeyboardButton("ุนุถูุช ุฏุฑ ฺฉุงูุงู", url=f"https://t.me/{FORCED_JOIN_CHANNEL.lstrip('@')}")]]
    text = f"โ๏ธ{user.mention_html()}ุ ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ุฑุจุงุช ุงุจุชุฏุง ุจุงุฏ ุฏุฑ ฺฉุงูุงู ูุง ุนุถู ุดู ู ูุฌุฏุฏุง ุฑุจุงุช ุฑุง ุงุณุชุงุฑุช ฺฉู:\n\n{FORCED_JOIN_CHANNEL}"

    target_chat = update.effective_chat
    sent_message = None
    if update.callback_query:
        await update.callback_query.answer()
        sent_message = await target_chat.send_message(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode=ParseMode.HTML)
    elif update.message:
        sent_message = await target_chat.send_message(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode=ParseMode.HTML)
    
    # Auto-delete the join message after 8 seconds
    if sent_message:
        await asyncio.sleep(8)
        try:
            await sent_message.delete()
        except Exception as e:
            logger.warning(f"Could not delete join message: {e}")

    return False

# --------------------------- HOKM GAME (Your Provided Stable Version) ---------------------------
def create_deck():
    """ฺฉ ุฏุณุชู ฺฉุงุฑุช ูุฑุชุจ ุดุฏู ตฒุชุง ุงุฌุงุฏ ู ุขู ุฑุง ุจูุฑ ูโุฒูุฏ."""
    suits = ['S', 'H', 'D', 'C']  # Spades, Hearts, Diamonds, Clubs
    ranks = list(range(2, 15))  # 2-10, J(11), Q(12), K(13), A(14)
    deck = [f"{s}{r}" for s in suits for r in ranks]
    random.shuffle(deck)
    return deck

def card_to_persian(card):
    """ฺฉุงุฑุช ุฑุง ุจู ูุฑูุช ูุงุฑุณ ุจุง ุงููุฌ ุชุจุฏู ูโฺฉูุฏ."""
    if not card: return "๐"
    suits = {'S': 'โ๏ธ', 'H': 'โฅ๏ธ', 'D': 'โฆ๏ธ', 'C': 'โฃ๏ธ'}
    ranks = {11: 'J', 12: 'Q', 13: 'K', 14: 'A'}
    suit, rank = card[0], int(card[1:])
    rank_display = str(ranks.get(rank, rank))
    return f"{suits[suit]} {rank_display}"

def get_card_value(card, hokm_suit, trick_suit):
    """ุงุฑุฒุด ุนุฏุฏ ฺฉ ฺฉุงุฑุช ุฑุง ุจุฑุง ููุงุณู ู ุชุนู ุจุฑูุฏู ุฏุณุช ูุญุงุณุจู ูโฺฉูุฏ."""
    suit, rank = card[0], int(card[1:])
    value = rank
    if suit == hokm_suit:
        value += 200
    elif suit == trick_suit:
        value += 100
    return value

async def render_hokm_board(game: dict, context: ContextTypes.DEFAULT_TYPE):
    game_id = game['message_id']
    keyboard = []
    
    if game['mode'] == '4p':
        p_names = [p['name'] for p in game['players']]
        p_ids = [p['id'] for p in game['players']]
        team_a_text = f"๐ด ุชู 1: {p_names[0]} ู {p_names[2]}"
        team_b_text = f"๐ต ุชู 2: {p_names[1]} ู {p_names[3]}"
        
        table_cards_map = {pid: "โ" for pid in p_ids}
        for play in game.get('current_trick', []):
            table_cards_map[play['player_id']] = card_to_persian(play['card'])

        table_cards = [table_cards_map[pid] for pid in p_ids]

        board_layout = [
            [InlineKeyboardButton(team_a_text, callback_data=f"hokm_noop_{game_id}")],
            [InlineKeyboardButton(team_b_text, callback_data=f"hokm_noop_{game_id}")],
            [InlineKeyboardButton("ุจุงุฒฺฉู", callback_data=f"hokm_noop_{game_id}"), InlineKeyboardButton("ฺฉุงุฑุช ุจุงุฒ ุดุฏู", callback_data=f"hokm_noop_{game_id}")],
            [InlineKeyboardButton(p_names[0], callback_data=f"hokm_noop_{game_id}"), InlineKeyboardButton(table_cards[0], callback_data=f"hokm_noop_{game_id}")],
            [InlineKeyboardButton(p_names[1], callback_data=f"hokm_noop_{game_id}"), InlineKeyboardButton(table_cards[1], callback_data=f"hokm_noop_{game_id}")],
            [InlineKeyboardButton(p_names[2], callback_data=f"hokm_noop_{game_id}"), InlineKeyboardButton(table_cards[2], callback_data=f"hokm_noop_{game_id}")],
            [InlineKeyboardButton(p_names[3], callback_data=f"hokm_noop_{game_id}"), InlineKeyboardButton(table_cards[3], callback_data=f"hokm_noop_{game_id}")],
        ]
        keyboard.extend(board_layout)
    else:
        p_names = [p['name'] for p in game['players']]
        p_ids = [p['id'] for p in game['players']]

        table_cards_map = {p_ids[0]: "โ", p_ids[1]: "โ"}
        for play in game.get('current_trick', []):
            table_cards_map[play['player_id']] = card_to_persian(play['card'])

        board_layout = [
            [InlineKeyboardButton(f"{p_names[0]}", callback_data=f"hokm_noop_{game_id}"), InlineKeyboardButton(table_cards_map[p_ids[0]], callback_data=f"hokm_noop_{game_id}")],
            [InlineKeyboardButton(f"{p_names[1]}", callback_data=f"hokm_noop_{game_id}"), InlineKeyboardButton(table_cards_map[p_ids[1]], callback_data=f"hokm_noop_{game_id}")],
        ]
        keyboard.extend(board_layout)

    hokm_suit_fa = card_to_persian(f"{game['hokm_suit']}2")[0] if game.get('hokm_suit') else 'โ'
    hakem_name = game.get('hakem_name', '...')
    
    if game['mode'] == '4p':
        trick_score_text = f"ุฏุณุช: ๐ด {game['trick_scores']['A']} - {game['trick_scores']['B']} ๐ต"
        game_score_text = f"ุงูุชุงุฒ ฺฉู: ๐ด {game['game_scores']['A']} - {game['game_scores']['B']} ๐ต"
    else:
        p_ids = [p['id'] for p in game['players']]
        trick_score_text = f"ุฏุณุช: {p_names[0]} {game['trick_scores'][p_ids[0]]} - {game['trick_scores'][p_ids[1]]} {p_names[1]}"
        game_score_text = f"ุงูุชุงุฒ ฺฉู: {p_names[0]} {game['game_scores'][p_ids[0]]} - {game['game_scores'][p_ids[1]]} {p_names[1]}"

    keyboard.append([InlineKeyboardButton(f"ุญุงฺฉู: {hakem_name}", callback_data=f"hokm_noop_{game_id}"), InlineKeyboardButton(f"ุญฺฉู: {hokm_suit_fa}", callback_data=f"hokm_noop_{game_id}")])
    keyboard.append([InlineKeyboardButton(trick_score_text, callback_data=f"hokm_noop_{game_id}")])
    keyboard.append([InlineKeyboardButton(game_score_text, callback_data=f"hokm_noop_{game_id}")])

    keyboard.append([InlineKeyboardButton("๐ ููุงุด ุฏุณุช ูู (ุฎุตูุต)", callback_data=f"hokm_showhand_{game_id}")])

    if game['status'] == 'hakem_choosing':
        suit_map = {'โ๏ธ': 'S', 'โฅ๏ธ': 'H', 'โฆ๏ธ': 'D', 'โฃ๏ธ': 'C'}
        choose_buttons = [InlineKeyboardButton(emoji, callback_data=f"hokm_choose_{game_id}_{char}") for emoji, char in suit_map.items()]
        keyboard.append(choose_buttons)
    elif game['status'] == 'playing':
        current_turn_player_id = game['players'][game['turn_index']]['id']
        if current_turn_player_id in game['hands']:
            player_hand = sorted(game['hands'][current_turn_player_id])
            card_buttons = [InlineKeyboardButton(str(i + 1), callback_data=f"hokm_play_{game_id}_{i}") for i in range(len(player_hand))]
            for i in range(0, len(card_buttons), 7):
                keyboard.append(card_buttons[i:i+7])
    
    return InlineKeyboardMarkup(keyboard)

async def hokm_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await pre_command_check(update, context): return
    if update.effective_chat.type == 'private':
        await update.message.reply_text("ุจุงุฒ ุญฺฉู ููุท ุฏุฑ ฺฏุฑููโูุง ูุงุจู ุงุฌุฑุงุณุช.")
        return

    keyboard = [
        [
            InlineKeyboardButton("๐ ฒ ููุฑู", callback_data="hokm_start_2p"),
            InlineKeyboardButton("๐จโ๐ฉโ๐งโ๐ฆ ด ููุฑู", callback_data="hokm_start_4p")
        ]
    ]
    await update.message.reply_text("ุญุงูุช ุจุงุฒ ุญฺฉู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ:", reply_markup=InlineKeyboardMarkup(keyboard))

async def hokm_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    chat_id = query.message.chat.id
        
    data = query.data.split('_'); action = data[1]

    if action == "start":
        if not await is_user_in_channel(user.id, context):
            await query.answer(f"โ๏ธุจุฑุง ุดุฑูุน ุจุงุฒุ ุงุจุชุฏุง ุจุงุฏ ุฏุฑ ฺฉุงูุงู {FORCED_JOIN_CHANNEL} ุนุถู ุดูุฏ.", show_alert=True)
            return
        await query.answer()
        mode = data[2]; max_players = 4 if mode == '4p' else 2
        if chat_id not in active_games['hokm']: active_games['hokm'][chat_id] = {}
        
        # <<<--- Hokm Join Text Updated --->>>
        join_text = (
            f"ุจุงุฒ ุญฺฉู {max_players} ููุฑู!\n\n"
            f"ุจุงุฒฺฉูุงู ุจุฑุง ูุฑูุฏ ุจุงุฏ ุนุถู ฺฉุงูุงู {FORCED_JOIN_CHANNEL} ุจุงุดูุฏ.\n\n"
            "ููุชุธุฑ ูุฑูุฏ ุจุงุฒฺฉูุงู..."
        )
        msg = await query.edit_message_text(join_text)
        
        game_id = msg.message_id
        active_games['hokm'][chat_id][game_id] = {"status": "joining", "mode": mode, "players": [{'id': user.id, 'name': user.first_name}], "message_id": game_id}
        keyboard = [[InlineKeyboardButton(f"Join Game (1/{max_players})", callback_data=f"hokm_join_{game_id}")]]
        await query.edit_message_reply_markup(reply_markup=InlineKeyboardMarkup(keyboard)); return

    game_id = int(data[2])
    if chat_id not in active_games['hokm'] or game_id not in active_games['hokm'][chat_id]:
        await query.answer("ุงู ุจุงุฒ ุฏฺฏุฑ ูุนุงู ูุณุช.", show_alert=True)
        try: await query.edit_message_text("ุงู ุจุงุฒ ุชูุงู ุดุฏู ุงุณุช.")
        except: pass
        return
    
    game = active_games['hokm'][chat_id][game_id]

    if action == "join":
        # <<<--- Hokm Membership Check on Join --->>>
        if not await is_user_in_channel(user.id, context):
            await query.answer(f"โ๏ธุจุฑุง ูพูุณุชู ุจู ุจุงุฒุ ุงุจุชุฏุง ุจุงุฏ ุฏุฑ ฺฉุงูุงู {FORCED_JOIN_CHANNEL} ุนุถู ุดูุฏ.", show_alert=True)
            return

        if any(p['id'] == user.id for p in game['players']): 
            await query.answer("ุดูุง ูุจูุงู ุจู ุจุงุฒ ูพูุณุชูโุงุฏ!", show_alert=True)
            return
        max_players = 4 if game['mode'] == '4p' else 2
        if len(game['players']) >= max_players: 
            await query.answer("ุธุฑูุช ุจุงุฒ ุชฺฉูู ุงุณุช.", show_alert=True)
            return
        
        await query.answer(); game['players'].append({'id': user.id, 'name': user.first_name})
        num_players = len(game['players'])

        if num_players < max_players:
            keyboard = [[InlineKeyboardButton(f"Join Game ({num_players}/{max_players})", callback_data=f"hokm_join_{game_id}")]]
            
            join_text = (
                f"ุจุงุฒ ุญฺฉู {max_players} ููุฑู!\n\n"
                f"ุจุงุฒฺฉูุงู ุจุฑุง ูุฑูุฏ ุจุงุฏ ุนุถู ฺฉุงูุงู {FORCED_JOIN_CHANNEL} ุจุงุดูุฏ.\n\n"
                f"ุจุงุฒฺฉูุงู ูุงุฑุฏ ุดุฏู: {num_players}/{max_players}"
            )
            await query.edit_message_text(join_text, reply_markup=InlineKeyboardMarkup(keyboard))
        else:
            p_ids = [p['id'] for p in game['players']]
            game.update({
                "status": "dealing_first_5", "deck": create_deck(), "hands": {pid: [] for pid in p_ids},
                "hakem_id": None, "hakem_name": None, "turn_index": 0, "hokm_suit": None, "current_trick": [],
                "trick_scores": {'A': 0, 'B': 0} if game['mode'] == '4p' else {p_ids[0]: 0, p_ids[1]: 0},
                "game_scores": game.get('game_scores', {'A': 0, 'B': 0} if game['mode'] == '4p' else {p_ids[0]: 0, p_ids[1]: 0})
            })

            for _ in range(5):
                for p in game['players']: game['hands'][p['id']].append(game['deck'].pop(0))
            
            hakem_p = next((p for p in game['players'] if 'S14' in game['hands'][p['id']]), game['players'][0])
            game.update({"hakem_id": hakem_p['id'], "hakem_name": hakem_p['name'], "status": 'hakem_choosing'})
            
            reply_markup = await render_hokm_board(game, context)
            await query.edit_message_text(f"ุจุงุฒฺฉูุงู ฺฉุงูู ุดุฏูุฏ!\nุญุงฺฉู: **{game['hakem_name']}**\n\nุญุงฺฉู ุนุฒุฒุ ุจุฑ ุงุณุงุณ ต ฺฉุงุฑุช ุงูู ุฎูุฏุ ุญฺฉู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ.", reply_markup=reply_markup, parse_mode=ParseMode.MARKDOWN)

    elif action == "choose":
        if user.id != game.get('hakem_id'): return await query.answer("ุดูุง ุญุงฺฉู ูุณุชุฏ!", show_alert=True)
        await query.answer(); game['hokm_suit'] = data[3]
        for p in game['players']:
            while len(game['hands'][p['id']]) < 13: game['hands'][p['id']].append(game['deck'].pop(0))
        game['status'] = 'playing'
        game['turn_index'] = next(i for i, p in enumerate(game['players']) if p['id'] == game['hakem_id'])
        turn_player_name = game['players'][game['turn_index']]['name']
        reply_markup = await render_hokm_board(game, context)
        await query.edit_message_text(f"ุจุงุฒ ุดุฑูุน ุดุฏ! ุญฺฉู: **{card_to_persian(game['hokm_suit']+'2')[0]}**\n\nููุจุช **{turn_player_name}** ุงุณุช.", reply_markup=reply_markup, parse_mode=ParseMode.MARKDOWN)

    elif action == "showhand":
        if not any(p['id'] == user.id for p in game['players']): return await query.answer("ุดูุง ุจุงุฒฺฉู ุงู ูุณุงุจูู ูุณุชุฏ!", show_alert=True)
        hand = sorted(game['hands'].get(user.id, []))
        hand_str = "\n".join([f"{i+1}. {card_to_persian(c)}" for i, c in enumerate(hand)]) or "ุดูุง ฺฉุงุฑุช ุฏุฑ ุฏุณุช ูุฏุงุฑุฏ."
        await query.answer(f"ุฏุณุช ุดูุง:\n{hand_str}", show_alert=True)

    elif action == "play":
        if user.id != game['players'][game['turn_index']]['id']: return await query.answer("ููุจุช ุดูุง ูุณุช!", show_alert=True)
        card_index = int(data[3])
        hand = sorted(game['hands'][user.id]) 
        if not (0 <= card_index < len(hand)): return await query.answer("ุดูุงุฑู ฺฉุงุฑุช ูุงูุนุชุจุฑ ุงุณุช.", show_alert=True)
        
        card_played = hand[card_index]
        if game['current_trick']:
            trick_suit = game['current_trick'][0]['card'][0]
            if any(c.startswith(trick_suit) for c in hand) and not card_played.startswith(trick_suit):
                return await query.answer(f"ุดูุง ุจุงุฏ ุงุฒ ุฎุงู ุฒูู ({card_to_persian(trick_suit+'2')[0]}) ุจุงุฒ ฺฉูุฏ!", show_alert=True)

        await query.answer(); game['hands'][user.id].remove(card_played)
        game['current_trick'].append({'player_id': user.id, 'card': card_played})

        num_players = len(game['players'])
        if len(game['current_trick']) == num_players:
            trick_suit = game['current_trick'][0]['card'][0]
            winner_play = max(game['current_trick'], key=lambda p: get_card_value(p['card'], game['hokm_suit'], trick_suit))
            winner_id = winner_play['player_id']
            winner_name = next(p['name'] for p in game['players'] if p['id'] == winner_id)
            
            if game['mode'] == '4p':
                winner_team = 'A' if winner_id in [game['players'][0]['id'], game['players'][2]['id']] else 'B'
                game['trick_scores'][winner_team] += 1
                round_over = game['trick_scores']['A'] == 7 or game['trick_scores']['B'] == 7
            else:
                game['trick_scores'][winner_id] += 1
                round_over = any(score == 7 for score in game['trick_scores'].values())

            game['turn_index'] = next(i for i, p in enumerate(game['players']) if p['id'] == winner_id)
            
            trick_cards_for_display = game['current_trick'][:]
            game['current_trick'] = []
            
            if round_over:
                if game['mode'] == '4p':
                    winning_team_name = 'A' if game['trick_scores']['A'] == 7 else 'B'
                    game['game_scores'][winning_team_name] += 1
                    winner_display_name = f"ุชู {winning_team_name}"
                    game_over = game['game_scores'][winning_team_name] == 7
                else:
                    round_winner_id = next(pid for pid, score in game['trick_scores'].items() if score == 7)
                    winner_display_name = next(p['name'] for p in game['players'] if p['id'] == round_winner_id)
                    game['game_scores'][round_winner_id] += 1
                    game_over = game['game_scores'][round_winner_id] == 7

                if game_over:
                    await query.edit_message_text(f"๐ **ุจุงุฒ ุชูุงู ุดุฏ!** ๐\n\nุจุฑูุฏู ููุง: **{winner_display_name}**", parse_mode=ParseMode.MARKDOWN)
                    del active_games['hokm'][chat_id][game_id]; return
                
                current_hakem_index = next(i for i, p in enumerate(game['players']) if p['id'] == game['hakem_id'])
                if game['mode'] == '4p':
                    hakem_team = 'A' if game['hakem_id'] in [game['players'][0]['id'], game['players'][2]['id']] else 'B'
                    next_hakem_index = current_hakem_index if winning_team_name == hakem_team else (current_hakem_index + 1) % 4
                else:
                    round_winner_id = next(pid for pid, score in game['trick_scores'].items() if score == 7)
                    next_hakem_index = current_hakem_index if round_winner_id == game['hakem_id'] else (current_hakem_index + 1) % 2
                
                p_ids = [p['id'] for p in game['players']]
                game.update({ "status": "dealing_first_5", "deck": create_deck(), "hands": {pid: [] for pid in p_ids},
                                "trick_scores": {'A': 0, 'B': 0} if game['mode'] == '4p' else {p_ids[0]: 0, p_ids[1]: 0} })
                for _ in range(5):
                    for p in game['players']: game['hands'][p['id']].append(game['deck'].pop(0))
                game['hakem_id'] = game['players'][next_hakem_index]['id']
                game['hakem_name'] = game['players'][next_hakem_index]['name']
                game['status'] = 'hakem_choosing'

                reply_markup = await render_hokm_board(game, context)
                await query.edit_message_text(f"ุฏุณุช ุชูุงู ุดุฏ! ุจุฑูุฏู: **{winner_display_name}**\n\nุญุงฺฉู ุฌุฏุฏ: **{game['hakem_name']}**\nููุชุธุฑ ุงูุชุฎุงุจ ุญฺฉู...", reply_markup=reply_markup, parse_mode=ParseMode.MARKDOWN)
            
            else:
                turn_player_name = game['players'][game['turn_index']]['name']
                
                temp_game_state = game.copy()
                temp_game_state['current_trick'] = trick_cards_for_display
                temp_reply_markup = await render_hokm_board(temp_game_state, context)
                await query.edit_message_text(f"ุจุฑูุฏู ุงู ุฏุณุช: **{winner_name}**\n\nููุจุช **{turn_player_name}** ุงุณุช.", reply_markup=temp_reply_markup, parse_mode=ParseMode.MARKDOWN)
                
                await asyncio.sleep(2.5) 
                
                reply_markup = await render_hokm_board(game, context)
                await query.edit_message_text(f"ุญฺฉู: **{card_to_persian(game['hokm_suit']+'2')[0]}**\n\nููุจุช **{turn_player_name}** ุงุณุช.", reply_markup=reply_markup, parse_mode=ParseMode.MARKDOWN)
        
        else:
            game['turn_index'] = (game['turn_index'] + 1) % num_players
            turn_player_name = game['players'][game['turn_index']]['name']
            reply_markup = await render_hokm_board(game, context)
            await query.edit_message_text(f"ุญฺฉู: **{card_to_persian(game['hokm_suit']+'2')[0]}**\n\nููุจุช **{turn_player_name}** ุงุณุช.", reply_markup=reply_markup, parse_mode=ParseMode.MARKDOWN)
            
    elif action == "noop":
        await query.answer()

# --------------------------- GUESS THE NUMBER GAME ---------------------------
SELECTING_RANGE, GUESSING = range(2)
async def hads_addad_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if update.effective_chat.type == 'private':
        await update.message.reply_text("ุงู ุจุงุฒ ููุท ุฏุฑ ฺฏุฑููโูุง ูุงุจู ุงุฌุฑุงุณุช.")
        return ConversationHandler.END

    if not await is_group_admin(update.effective_user.id, update.effective_chat.id, context):
        await update.message.reply_text("โ ุงู ุจุงุฒ ููุท ุชูุณุท ุงุฏููโูุง ฺฏุฑูู ูุงุจู ุดุฑูุน ุงุณุช.")
        return ConversationHandler.END

    if update.effective_chat.id in active_games['guess_number']:
        await update.message.reply_text("ฺฉ ุจุงุฒ ุญุฏุณ ุนุฏุฏ ุฏุฑ ุงู ฺฏุฑูู ูุนุงู ุงุณุช.")
        return ConversationHandler.END
        
    await update.message.reply_text("ุจุงุฒู ุจุงุฒ ุฑุง ูุดุฎุต ฺฉูุฏ. (ูุซุงู: `1-1000`)", parse_mode=ParseMode.MARKDOWN)
    return SELECTING_RANGE

async def receive_range(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    chat = update.effective_chat
    try:
        min_str, max_str = convert_persian_to_english_numbers(update.message.text).split('-')
        min_range, max_range = int(min_str.strip()), int(max_str.strip())
        if min_range >= max_range: raise ValueError
    except:
        await update.message.reply_text("ูุฑูุช ุงุดุชุจุงู ุงุณุช. ูุทูุง ุจู ุงู ุตูุฑุช ูุงุฑุฏ ฺฉูุฏ: `ุนุฏุฏ ฺฉูฺฺฉ-ุนุฏุฏ ุจุฒุฑฺฏ`", parse_mode=ParseMode.MARKDOWN)
        return SELECTING_RANGE
    secret_number = random.randint(min_range, max_range)
    active_games['guess_number'][chat.id] = {"number": secret_number}
    await update.message.reply_text(f"๐ฒ **ุจุงุฒ ุญุฏุณ ุนุฏุฏ ุดุฑูุน ุดุฏ!** ๐ฒ\n\nฺฉ ุนุฏุฏ ุจู **{min_range}** ู **{max_range}** ุงูุชุฎุงุจ ุดุฏู.", parse_mode=ParseMode.MARKDOWN)
    return GUESSING

async def handle_guess_conversation(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    chat_id = update.effective_chat.id
    if chat_id not in active_games['guess_number']: return ConversationHandler.END
    guess = int(convert_persian_to_english_numbers(update.message.text))
    secret_number = active_games['guess_number'][chat_id]['number']
    user = update.effective_user
    if guess < secret_number: await update.message.reply_text("ุจุงูุงุชุฑ โฌ๏ธ")
    elif guess > secret_number: await update.message.reply_text("ูพุงูโุชุฑ โฌ๏ธ")
    else:
        await update.message.reply_text(f"๐ **ุชุจุฑฺฉ!** {user.mention_html()} ุจุฑูุฏู ุดุฏ! ๐\n\nุนุฏุฏ ุตุญุญ **{secret_number}** ุจูุฏ.", parse_mode=ParseMode.HTML)
        del active_games['guess_number'][chat_id]
        return ConversationHandler.END
    return GUESSING

async def cancel_game(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if update.effective_chat.id in active_games['guess_number']: del active_games['guess_number'][update.effective_chat.id]
    await update.message.reply_text('ุจุงุฒ ุญุฏุณ ุนุฏุฏ ูุบู ุดุฏ.')
    return ConversationHandler.END

# --------------------------- DOOZ GAME (New Redesigned Flow) ---------------------------
async def dooz_start_direct_challenge(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()
    context.chat_data['dooz_challenger_id'] = query.from_user.id
    context.chat_data['dooz_panel_message_id'] = query.message.message_id
    
    text = (
        "๐ค **ุชุนู ุญุฑู ุจุฑุง ุจุงุฒ ุฏูุฒ**\n\n"
        "ูุทูุงู ูุฒุฑูู (ูุซูุงู @username)ุ ุขุฏ ุนุฏุฏ ุง ููุดู ุญุฑู ููุฑุฏ ูุธุฑ ุฎูุฏ ุฑุง ุฏุฑ ูพุงู ุจุนุฏ ุงุฑุณุงู ฺฉูุฏ."
    )
    keyboard = [[InlineKeyboardButton("๐ ุจุงุฒฺฏุดุช ุจู ูพูู", callback_data="panel_show_main")]]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
    
    return DOOZ_ASKING_OPPONENT

async def dooz_receive_opponent(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    challenger_id = context.chat_data.get('dooz_challenger_id')
    panel_message_id = context.chat_data.get('dooz_panel_message_id')
    challenger = await context.bot.get_chat(challenger_id)
    message = update.message
    
    challenged_user = None
    
    # Method 1: Mention
    if message.entities:
        for entity in message.entities:
            if entity.type == 'text_mention' and entity.user:
                challenged_user = entity.user

    # Method 2: Username
    if not challenged_user and message.text.startswith('@'):
        username_to_find = message.text.strip()[1:].lower()
        conn = get_db_connection()
        if conn:
            with conn.cursor() as cur:
                cur.execute("SELECT user_id FROM usernames WHERE username = %s;", (username_to_find,))
                result = cur.fetchone()
                if result:
                    try:
                        challenged_user = await context.bot.get_chat(result[0])
                    except Exception: pass
            conn.close()

    # Method 3: User ID
    if not challenged_user and message.text.isdigit():
        try:
            challenged_user = await context.bot.get_chat(int(message.text))
        except Exception as e:
            logger.error(f"Could not find user by ID for Dooz: {e}")

    if not challenged_user:
        await message.reply_text("ฺฉุงุฑุจุฑ ููุฑุฏ ูุธุฑ ุงูุช ูุดุฏ. ูุทูุงู ูุทูุฆู ุดูุฏ ฺฉุงุฑุจุฑ ุญุฏุงูู ฺฉ ุจุงุฑ ุจุง ุฑุจุงุช ุชุนุงูู ุฏุงุดุชู ุง ุงุฒ ููุดู ุงุณุชูุงุฏู ฺฉูุฏ.")
        return DOOZ_ASKING_OPPONENT

    if challenged_user.is_bot or challenged_user.id == challenger.id:
        await message.reply_text("ุดูุง ููโุชูุงูุฏ ุฑุจุงุชโูุง ุง ุฎูุฏุชุงู ุฑุง ุจู ุจุงุฒ ุฏุนูุช ฺฉูุฏ!")
        return DOOZ_ASKING_OPPONENT
    
    # Delete the panel message and the user's input message
    try:
        await context.bot.delete_message(chat_id=message.chat_id, message_id=panel_message_id)
    except Exception: pass
    
    challenged_mention = challenged_user.mention_html()
    cb_info = challenged_user.username if challenged_user.username else str(challenged_user.id)
    text = f"{challenger.mention_html()} ุดูุง ุฑุง ุจู ุจุงุฒ ุฏูุฒ ุฏุนูุช ฺฉุฑุฏ!"
    keyboard = [[
        InlineKeyboardButton("โ ูุจูู", callback_data=f"dooz_accept_{challenger.id}_{cb_info}"),
        InlineKeyboardButton("โ ุฑุฏ", callback_data=f"dooz_decline_{challenger.id}_{cb_info}")
    ]]
    await context.bot.send_message(
        chat_id=update.effective_chat.id,
        text=text,
        reply_markup=InlineKeyboardMarkup(keyboard),
        parse_mode=ParseMode.HTML
    )
    return ConversationHandler.END

async def dooz_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await force_join_middleware(update, context): 
        return
    if update.effective_chat.type == 'private':
        await update.message.reply_text("ุงู ุจุงุฒ ููุท ุฏุฑ ฺฏุฑููโูุง ูุงุจู ุงุฌุฑุงุณุช.")
        return
        
    challenger, challenged_user = update.effective_user, None
    if update.message.reply_to_message:
        challenged_user = update.message.reply_to_message.from_user
        if challenged_user.is_bot:
            await update.message.reply_text("ุดูุง ููโุชูุงูุฏ ุฑุจุงุชโูุง ุฑุง ุจู ุจุงุฒ ุฏุนูุช ฺฉูุฏ!")
            return
        if challenged_user.id == challenger.id:
            await update.message.reply_text("ุดูุง ููโุชูุงูุฏ ุฎูุฏุชุงู ุฑุง ุจู ุจุงุฒ ุฏุนูุช ฺฉูุฏ!")
            return
    else:
        await update.message.reply_text("ุจุฑุง ุฏุนูุชุ ุฑู ูพุงู ฺฉ ููุฑ ุฑูพูุง ฺฉูุฏ. (`/dooz`)")
        return

    challenged_mention = challenged_user.mention_html()
    cb_info = challenged_user.username if challenged_user.username else str(challenged_user.id)

    text = f"{challenger.mention_html()} {challenged_mention} ุฑุง ุจู ุจุงุฒ ุฏูุฒ ุฏุนูุช ฺฉุฑุฏ!"
    keyboard = [[
        InlineKeyboardButton("โ ูุจูู", callback_data=f"dooz_accept_{challenger.id}_{cb_info}"),
        InlineKeyboardButton("โ ุฑุฏ", callback_data=f"dooz_decline_{challenger.id}_{cb_info}")
    ]]
    await update.message.reply_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode=ParseMode.HTML)

async def dooz_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    
    data = query.data.split('_')
    action = data[1]

    if action == "join":
        if not await is_user_in_channel(user.id, context):
            await query.answer(f"โ๏ธุจุฑุง ูพูุณุชู ุจู ุจุงุฒุ ุงุจุชุฏุง ุจุงุฏ ุฏุฑ ฺฉุงูุงู {FORCED_JOIN_CHANNEL} ุนุถู ุดูุฏ.", show_alert=True)
            return
            
        creator_id = int(data[2])
        if user.id == creator_id:
            await query.answer("ุดูุง ููโุชูุงูุฏ ุจู ุจุงุฒ ุฎูุฏุชุงู ููุญู ุดูุฏ!", show_alert=True)
            return

        await query.answer()
        creator_user = await context.bot.get_chat(creator_id)

        chat_id = query.message.chat.id
        game_id = query.message.message_id
        if chat_id not in active_games['dooz']: active_games['dooz'][chat_id] = {}

        active_games['dooz'][chat_id][game_id] = {
            "players": {creator_id: "โ", user.id: "โญ๏ธ"},
            "board": [[" "]*3 for _ in range(3)],
            "turn": creator_id
        }
        text = f"ุจุงุฒ ุดุฑูุน ุดุฏ!\n{creator_user.mention_html()} (โ) vs {user.mention_html()} (โญ๏ธ)\n\nููุจุช {creator_user.mention_html()} ุงุณุช."
        keyboard = [[
            InlineKeyboardButton(" ", callback_data=f"dooz_move_{game_id}_{r*3+c}_{creator_id}_{user.id}") 
            for c in range(3)] for r in range(3)
        ]
        await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode=ParseMode.HTML)

    elif action in ["accept", "decline"]:
        if not await is_user_in_channel(user.id, context):
            await query.answer(f"โ๏ธุจุฑุง ุชุนุงูู ุจุง ุจุงุฒุ ุงุจุชุฏุง ุจุงุฏ ุฏุฑ ฺฉุงูุงู {FORCED_JOIN_CHANNEL} ุนุถู ุดูุฏ.", show_alert=True)
            return

        await query.answer()
        p1_id, p2_info = int(data[2]), data[3]
        is_correct_user = (user.username and user.username.lower() == p2_info.lower()) or (str(user.id) == p2_info)
        
        if not is_correct_user:
            await query.answer("ุงู ุฏุนูุช ุจุฑุง ุดูุง ูุณุช!", show_alert=True)
            return
        if user.id == p1_id and action == "accept":
            await query.answer("ุดูุง ููโุชูุงูุฏ ุฏุนูุช ุฎูุฏุชุงู ุฑุง ูุจูู ฺฉูุฏ!", show_alert=True)
            return
        
        try:
            p1_user = await context.bot.get_chat(p1_id)
            p1_mention = p1_user.mention_html()
        except:
            p1_mention = f"ฺฉุงุฑุจุฑ {p1_id}"

        if action == "accept":
            chat_id = query.message.chat.id
            game_id = query.message.message_id
            if chat_id not in active_games['dooz']: active_games['dooz'][chat_id] = {}
            active_games['dooz'][chat_id][game_id] = {
                "players": {p1_id: "โ", user.id: "โญ๏ธ"},
                "board": [[" "]*3 for _ in range(3)],
                "turn": p1_id
            }
            text = f"ุจุงุฒ ุดุฑูุน ุดุฏ!\n{p1_mention} (โ) vs {user.mention_html()} (โญ๏ธ)\n\nููุจุช {p1_mention} ุงุณุช."
            keyboard = [[
                InlineKeyboardButton(" ", callback_data=f"dooz_move_{game_id}_{r*3+c}_{p1_id}_{user.id}") 
                for c in range(3)] for r in range(3)
            ]
            await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode=ParseMode.HTML)
        else:
            await query.edit_message_text(f"{user.mention_html()} ุฏุนูุช {p1_mention} ุฑุง ุฑุฏ ฺฉุฑุฏ.", parse_mode=ParseMode.HTML)

    elif action == "move":
        if not await is_user_in_channel(user.id, context):
            await query.answer(f"โ๏ธุจุฑุง ุจุงุฒุ ุงุจุชุฏุง ุจุงุฏ ุฏุฑ ฺฉุงูุงู {FORCED_JOIN_CHANNEL} ุนุถู ุดูุฏ.", show_alert=True)
            return
            
        await query.answer()
        chat_id = query.message.chat.id
        game_id = int(data[2])
        p1_id = int(data[4])
        p2_id = int(data[5])

        if chat_id not in active_games['dooz'] or game_id not in active_games['dooz'][chat_id]:
            await query.answer("ุงู ุจุงุฒ ุชูุงู ุดุฏู ุงุณุช.", show_alert=True)
            return
        
        game = active_games['dooz'][chat_id][game_id]
        if user.id not in [p1_id, p2_id]:
            await query.answer("ุดูุง ุจุงุฒฺฉู ุงู ูุณุงุจูู ูุณุชุฏ!", show_alert=True)
            return
        if user.id != game['turn']:
            await query.answer("ููุจุช ุดูุง ูุณุช!", show_alert=True)
            return

        cell_index = int(data[3])
        row, col = divmod(cell_index, 3)
        if game['board'][row][col] != " ":
            await query.answer("ุงู ุฎุงูู ูพุฑ ุดุฏู ุงุณุช!", show_alert=True)
            return
        
        symbol = game['players'][user.id]
        game['board'][row][col] = symbol
        
        b = game['board']
        win = any(all(c==symbol for c in r) for r in b) or \
                any(all(b[r][c]==symbol for r in range(3)) for c in range(3)) or \
                all(b[i][i]==symbol for i in range(3)) or \
                all(b[i][2-i]==symbol for i in range(3))
        
        is_draw = all(c!=" " for r in b for c in r) and not win
        winner = user.id if win else "draw" if is_draw else None
        
        game['turn'] = p2_id if user.id == p1_id else p1_id
        
        board_rows = []
        for r in range(3):
            row_buttons = []
            for c in range(3):
                row_buttons.append(InlineKeyboardButton(b[r][c], callback_data=f"dooz_move_{game_id}_{r*3+c}_{p1_id}_{p2_id}"))
            board_rows.append(row_buttons)

        if winner:
            text = "ุจุงุฒ ูุณุงู ุดุฏ!" if winner == "draw" else f"ุจุงุฒ ุชูุงู ุดุฏ! ุจุฑูุฏู: {user.mention_html()} ๐"
            del active_games['dooz'][chat_id][game_id]
            if not active_games['dooz'][chat_id]:
                del active_games['dooz'][chat_id]
        else:
            try:
                p_turn_user = await context.bot.get_chat(game['turn'])
                text = f"ููุจุช {p_turn_user.mention_html()} ุงุณุช."
            except:
                text = f"ููุจุช ุจุงุฒฺฉู ุจุนุฏ ุงุณุช."
        
        await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(board_rows), parse_mode=ParseMode.HTML)

# --------------------------- HADS KALAME GAME ---------------------------
async def hads_kalame_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await pre_command_check(update, context): return
    
    chat = update.effective_chat
    if chat.id in active_games['hangman']: 
        await chat.send_message("ฺฉ ุจุงุฒ ุญุฏุณ ฺฉููู ูุนุงู ุงุณุช.")
        return
        
    word = random.choice(WORD_LIST)
    active_games['hangman'][chat.id] = {"word": word, "display": ["_"] * len(word), "guessed_letters": set(), "players": {}}
    game = active_games['hangman'][chat.id]
    text = f"๐ต๏ธโโ๏ธ **ุญุฏุณ ฺฉููู (ุฑูุงุจุช) ุดุฑูุน ุดุฏ!**\n\nูุฑ ฺฉุงุฑุจุฑ {INITIAL_LIVES} ุฌุงู ุฏุงุฑุฏ.\nฺฉููู: `{' '.join(game['display'])}`"
    await chat.send_message(text, parse_mode=ParseMode.MARKDOWN)

async def handle_letter_guess(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id, user = update.effective_chat.id, update.effective_user
    if chat_id not in active_games['hangman']: return
    if not await pre_command_check(update, context): return

    guess = update.message.text.strip()
    game = active_games['hangman'][chat_id]
    
    if user.id not in game['players']: game['players'][user.id] = INITIAL_LIVES
    if game['players'][user.id] == 0: return
    if guess in game['guessed_letters']: return

    game['guessed_letters'].add(guess)
    if guess in game['word']:
        for i, letter in enumerate(game['word']):
            if letter == guess: game['display'][i] = letter
        if "_" not in game['display']:
            await update.message.reply_text(f"โ **{user.mention_html()}** ุจุฑูุฏู ุดุฏ! ฺฉููู ุตุญุญ `{game['word']}` ุจูุฏ.", parse_mode=ParseMode.HTML)
            del active_games['hangman'][chat_id]
        else:
            await update.message.reply_text(f"`{' '.join(game['display'])}`", parse_mode=ParseMode.MARKDOWN)
    else:
        game['players'][user.id] -= 1
        lives_left = game['players'][user.id]
        if lives_left > 0:
            await update.message.reply_text(f"ุงุดุชุจุงู ุจูุฏ {user.mention_html()}! ุดูุง **{lives_left}** ุฌุงู ุฏฺฏุฑ ุฏุงุฑุฏ.", parse_mode=ParseMode.HTML)
        else:
            await update.message.reply_text(f"{user.mention_html()} ุชูุงู ุฌุงูโูุง ุฎูุฏ ุฑุง ุงุฒ ุฏุณุช ุฏุงุฏ ู ุงุฒ ุจุงุฒ ุญุฐู ุดุฏ.", parse_mode=ParseMode.HTML)
            # Check if all players with lives are out
            players_with_lives = [p for p in game['players'] if game['players'][p] > 0]
            if not players_with_lives:
                await update.message.reply_text(f"โ๏ธ ููู ุจุงุฎุชุฏ! ฺฉููู ุตุญุญ `{game['word']}` ุจูุฏ.", parse_mode=ParseMode.MARKDOWN)
                del active_games['hangman'][chat_id]

# --------------------------- GHARCH & ETERAF GAMES ---------------------------
async def gharch_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    # This function is now only called from the panel or directly by an admin
    chat = update.effective_chat
    user = update.effective_user
    if chat.type == 'private':
        await chat.send_message("ุงู ุจุงุฒ ููุท ุฏุฑ ฺฏุฑููโูุง ูุงุจู ุงุฌุฑุงุณุช.")
        return ConversationHandler.END
        
    if not await is_group_admin(user.id, chat.id, context):
        await chat.send_message("โ ููุท ุงุฏููโูุง ฺฏุฑูู ูโุชูุงููุฏ ุงู ุจุงุฒ ุฑุง ุดุฑูุน ฺฉููุฏ.")
        return ConversationHandler.END
    
    context.chat_data['starter_admin_id'] = user.id
    
    # Use reply_to_message_id if available (from panel call)
    reply_to_id = update.message.message_id
    
    sent_message = await chat.send_message(
        "๐ **ุดุฑูุน ุจุงุฒ ูุงุฑฺ**\n\n"
        "ูุทูุงู ูุฒุฑูู ฺฏุงุฏ ุจุงุฒ ุฑุง ุงุฑุณุงู ฺฉูุฏ.",
        reply_to_message_id=reply_to_id
    )
    context.chat_data['gharch_setup_message_id'] = sent_message.message_id
    
    return ASKING_GOD_USERNAME

async def receive_god_username(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    god_username = update.message.text.strip()
    if not god_username.startswith('@'):
        await update.message.reply_text("ูุฑูุช ุงุดุชุจุงู ุงุณุช. ูุทูุงู ูุฒุฑูู ุฑุง ุจุง @ ุงุฑุณุงู ฺฉูุฏ.", quote=True)
        return ASKING_GOD_USERNAME

    context.chat_data['god_username'] = god_username
    starter_admin_id = context.chat_data['starter_admin_id']
    setup_message_id = context.chat_data.get('gharch_setup_message_id')

    try:
        await update.message.delete()
    except Exception as e:
        logger.warning(f"Could not delete admin's username message: {e}")

    if not setup_message_id:
        await context.bot.send_message(update.effective_chat.id, "ุฎุทุง ุฏุฑ ุงูุชู ูพุงู ุงุตู ุฑุฎ ุฏุงุฏ. ูุทูุงู ุจุงุฒ ุฑุง ุจุง /cancel ูุบู ู ูุฌุฏุฏุงู ุดุฑูุน ฺฉูุฏ.")
        return ConversationHandler.END

    keyboard = [[
        InlineKeyboardButton("โ ุชุงุฏ ูโฺฉูู", callback_data=f"gharch_confirm_god_{starter_admin_id}")
    ]]
    
    await context.bot.edit_message_text(
        chat_id=update.effective_chat.id,
        message_id=setup_message_id,
        text=(
            f"{god_username} ุนุฒุฒุ\n"
            f"ุดูุง ุจู ุนููุงู ฺฏุงุฏ ุจุงุฒ ูุงุฑฺ ุงูุชุฎุงุจ ุดุฏุฏ. ูุทูุงู ุจุฑุง ุดุฑูุน ุจุงุฒุ ุงู ูุณุฆููุช ุฑุง ุชุงุฏ ฺฉูุฏ.\n\n"
            f"โ๏ธ **ูฺฉุชู:** ุจุฑุง ุฏุฑุงูุช ฺฏุฒุงุฑุดโูุงุ ุจุงุฏ ุฑุจุงุช ุฑุง ุงุณุชุงุฑุช ฺฉุฑุฏู ุจุงุดุฏ."
        ),
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    
    return CONFIRMING_GOD

async def confirm_god(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    user = query.from_user
    chat_id = query.message.chat.id
    
    god_username_from_admin = context.chat_data.get('god_username', '').lower().lstrip('@')

    if not user.username or user.username.lower() != god_username_from_admin:
        await query.answer("ุงู ุฏุฑุฎูุงุณุช ุจุฑุง ุดูุง ูุณุชุ ุง ูุฒุฑูู ุชูฺฏุฑุงู ุดูุง ุชูุธู ูุดุฏู ุงุณุช.", show_alert=True)
        return CONFIRMING_GOD

    await query.answer("ุดูุง ุจู ุนููุงู ฺฏุงุฏ ุชุงุฏ ุดุฏุฏ!")

    try:
        god_id = user.id
        god_username_display = f"@{user.username}"
        active_gharch_games[chat_id] = {'god_id': god_id, 'god_username': god_username_display}

        bot_username = (await context.bot.get_me()).username
        game_message_text = (
            "**ุจุงุฒ ูุงุฑฺ ๐ ุดุฑูุน ุดุฏ!**\n\n"
            "ุฑู ุฏฺฉูู ุฒุฑ ฺฉูฺฉ ฺฉู ู ุญุฑู ุฏูุช ุฑู ุจููุณ ุชุง ุจู ุตูุฑุช ูุงุดูุงุณ ุฏุฑ ฺฏุฑูู ุธุงูุฑ ุจุดู!\n\n"
            f"*(ููุท ฺฏุงุฏ ุจุงุฒุ {god_username_display}ุ ุงุฒ ููุช ุงุฑุณุงูโฺฉููุฏู ูุทูุน ุฎูุงูุฏ ุดุฏ.)*"
        )
        keyboard = [[InlineKeyboardButton("๐ ุงุฑุณุงู ูพุงู ูุงุดูุงุณ", url=f"https://t.me/{bot_username}?start=gharch_{chat_id}")]]
        
        await query.edit_message_text(
            text=game_message_text,
            reply_markup=InlineKeyboardMarkup(keyboard),
            parse_mode=ParseMode.MARKDOWN
        )
        
        try:
            await context.bot.pin_chat_message(chat_id, query.message.message_id)
            active_gharch_games[chat_id]['pinned_message_id'] = query.message.message_id
        except Exception as pin_error:
            logger.warning(f"Could not pin message in group {chat_id}. Reason: {pin_error}")
            await context.bot.send_message(
                chat_id=chat_id,
                text="โ ุจุงุฒ ุจุง ููููุช ุดุฑูุน ุดุฏ. ุงุฏููโูุง ุนุฒุฒุ ูุทูุงู ุงู ูพุงู ุฑุง ูพู ฺฉูุฏ.",
                reply_to_message_id=query.message.message_id
            )

    except Exception as e:
        error_message = f"๐ซ **ุฎุทุง ูุงุดูุงุฎุชู!**\n\nุฑุจุงุช ุฏุฑ ุณุงุฎุช ุจุงุฒ ุจุง ฺฉ ุฎุทุง ุบุฑููุชุธุฑู ููุงุฌู ุดุฏ: `{e}`"
        await context.bot.send_message(chat_id=chat_id, text=error_message, parse_mode=ParseMode.MARKDOWN)
        logger.error(f"CRITICAL ERROR in confirm_god: {e}")
        return ConversationHandler.END

    return ConversationHandler.END

async def cancel_gharch(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    await update.message.reply_text("ูุฑุขูุฏ ุณุงุฎุช ุจุงุฒ ูุงุฑฺ ูุบู ุดุฏ.")
    return ConversationHandler.END

async def eteraf_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    # This command is now for manual start with custom text
    if update.effective_chat.type == 'private':
        await update.message.reply_text("ุงู ุฏุณุชูุฑ ููุท ุฏุฑ ฺฏุฑููโูุง ูุงุจู ุงุณุชูุงุฏู ุงุณุช.")
        return

    user = update.effective_user
    chat_id = update.effective_chat.id
    if not await is_group_admin(user.id, chat_id, context):
        await update.message.reply_text("โ ุดูุง ุงุฌุงุฒู ุงุณุชูุงุฏู ุงุฒ ุงู ุฏุณุชูุฑ ุฑุง ูุฏุงุฑุฏ. ุงู ุฏุณุชูุฑ ูุฎุตูุต ูุฏุฑุงู ฺฏุฑูู ุงุณุช.")
        return

    if not await pre_command_check(update, context): 
        return

    custom_text = " ".join(context.args)
    if not custom_text:
        await update.message.reply_text("ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ุงู ุฏุณุชูุฑุ ูุชู ุณูุงุฑุด ุฎูุฏ ุฑุง ุจุนุฏ ุงุฒ ุขู ุจููุณุฏ.\nูุซุงู: `/eteraf ุงูุดุจ ุฏุฑ ููุฑุฏ ฺู ฺุฒ ุงุนุชุฑุงู ูโฺฉูุฏุ`")
        return

    bot_username = (await context.bot.get_me()).username
    starter_message = await update.message.reply_text(custom_text)
    keyboard = [[InlineKeyboardButton("๐คซ ุงุฑุณุงู ุงุนุชุฑุงู", url=f"https://t.me/{bot_username}?start=eteraf_{chat_id}_{starter_message.message_id}")]]
    await starter_message.edit_reply_markup(reply_markup=InlineKeyboardMarkup(keyboard))

# <<<--- New functions for Eteraf Conversation from panel --->>>
async def eteraf_start_custom_text(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()
    
    context.chat_data['eteraf_panel_message_id'] = query.message.message_id
    context.chat_data['eteraf_admin_id'] = query.from_user.id

    text = "โ๏ธ **ูุชู ุณูุงุฑุด ุงุนุชุฑุงู**\n\nูุทูุงู ูุชู ููุฑุฏ ูุธุฑ ุฎูุฏ ุฑุง ุจุฑุง ุดุฑูุน ููุถูุน ุงุนุชุฑุงู ุฏุฑ ูพุงู ุจุนุฏ ุงุฑุณุงู ฺฉูุฏ."
    keyboard = [[InlineKeyboardButton("๐ ุจุงุฒฺฏุดุช ุจู ูพูู", callback_data="panel_show_main")]]
    await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
    return ETERAF_ASKING_CUSTOM_TEXT

async def eteraf_receive_custom_text(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    admin_id = context.chat_data.get('eteraf_admin_id')
    # Ensure the message is from the admin who started the process
    if update.effective_user.id != admin_id:
        return ETERAF_ASKING_CUSTOM_TEXT

    panel_message_id = context.chat_data.get('eteraf_panel_message_id')
    custom_text = update.message.text
    chat_id = update.effective_chat.id

    try:
        await context.bot.delete_message(chat_id=chat_id, message_id=panel_message_id)
    except Exception: pass
    
    bot_username = (await context.bot.get_me()).username
    starter_message = await update.message.reply_text(custom_text)
    keyboard = [[InlineKeyboardButton("๐คซ ุงุฑุณุงู ุงุนุชุฑุงู", url=f"https://t.me/{bot_username}?start=eteraf_{chat_id}_{starter_message.message_id}")]]
    await starter_message.edit_reply_markup(reply_markup=InlineKeyboardMarkup(keyboard))

    return ConversationHandler.END


async def handle_anonymous_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_data = context.user_data
    if 'anon_target_chat' not in user_data:
        return await update.message.reply_text("ูุทูุงู ุงุจุชุฏุง ุงุฒ ุทุฑู ุฏฺฉููโุง ฺฉู ุฏุฑ ฺฏุฑูู ูุฑุงุฑ ุฏุงุฑุฏุ ูุฑุขูุฏ ุฑุง ุดุฑูุน ฺฉูุฏ.")
    
    target_info = user_data['anon_target_chat']
    target_chat_id = target_info['id']
    game_type = target_info['type']
    message_text = update.message.text

    try:
        if game_type == "gharch":
            if target_chat_id in active_gharch_games:
                sender = update.effective_user
                god_info = active_gharch_games[target_chat_id]
                god_id = god_info['god_id']

                await context.bot.send_message(
                    chat_id=target_chat_id,
                    text=f"#ูพุงู_ูุงุดูุงุณ ๐\n\n{message_text}"
                )
                await update.message.reply_text("โ ูพุงู ุดูุง ุจุง ููููุช ุจู ุตูุฑุช ูุงุดูุงุณ ุฏุฑ ฺฏุฑูู ุงุฑุณุงู ุดุฏ.")

                report_text = (
                    f"๐ **ฺฏุฒุงุฑุด ูพุงู ูุงุดูุงุณ ุฌุฏุฏ**\n\n"
                    f"๐ค **ุงุฑุณุงู ฺฉููุฏู:**\n"
                    f"- ูุงู: {sender.mention_html()}\n"
                    f"- ูุฒุฑูู: @{sender.username if sender.username else 'ูุฏุงุฑุฏ'}\n"
                    f"- ุขุฏ: `{sender.id}`\n\n"
                    f"๐ **ูุชู ูพุงู:**\n"
                    f"{message_text}"
                )
                await context.bot.send_message(chat_id=god_id, text=report_text, parse_mode=ParseMode.HTML)
            else:
                await update.message.reply_text("ุงู ุจุงุฒ ูุงุฑฺ ุฏฺฏุฑ ูุนุงู ูุณุช ุง ูููุถ ุดุฏู ุงุณุช.")

        elif game_type == "eteraf":
            reply_to_id = target_info.get('reply_to')
            header = "#ุงุนุชุฑุงู_ูุงุดูุงุณ ๐คซ"
            await context.bot.send_message(
                chat_id=target_chat_id,
                text=f"{header}\n\n{message_text}",
                reply_to_message_id=reply_to_id
            )
            await update.message.reply_text("โ ุงุนุชุฑุงู ุดูุง ุจุง ููููุช ุจู ุตูุฑุช ูุงุดูุงุณ ุฏุฑ ฺฏุฑูู ุงุฑุณุงู ุดุฏ.")
        
        else:
            await update.message.reply_text("ููุน ุจุงุฒ ูุงุดูุงุณ ูุดุฎุต ูุณุช.")

    except Exception as e:
        await update.message.reply_text(f"โ๏ธ ุงุฑุณุงู ูพุงู ุจุง ุฎุทุง ููุงุฌู ุดุฏ: {e}")
        logger.error(f"Error in handle_anonymous_message for game {game_type}: {e}")
    finally:
        if 'anon_target_chat' in context.user_data:
            del context.user_data['anon_target_chat']

# --------------------------- TYPE SPEED GAME ---------------------------
def create_typing_image(text: str) -> io.BytesIO:
    reshaped_text = arabic_reshaper.reshape(text)
    bidi_text = get_display(reshaped_text)
    try:
        font = ImageFont.truetype("Vazir.ttf", 24)
    except IOError:
        logger.warning("Vazir.ttf font not found. Falling back to default.")
        font = ImageFont.load_default()
    
    dummy_img, draw = Image.new('RGB', (1, 1)), ImageDraw.Draw(Image.new('RGB', (1, 1)))
    _, _, w, h = draw.textbbox((0, 0), bidi_text, font=font)
    img = Image.new('RGB', (w + 40, h + 40), color=(255, 255, 255))
    ImageDraw.Draw(img).text((20, 20), bidi_text, fill=(0, 0, 0), font=font)
    bio = io.BytesIO()
    bio.name = 'image.jpeg'
    img.save(bio, 'JPEG')
    bio.seek(0)
    return bio

async def type_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await pre_command_check(update, context): return
    
    chat = update.effective_chat
    if chat.id in active_games['typing']: 
        await chat.send_message("ฺฉ ุจุงุฒ ุชุงูพ ุณุฑุนุช ูุนุงู ุงุณุช.")
        return

    sentence = random.choice(TYPING_SENTENCES)
    active_games['typing'][chat.id] = {"sentence": sentence, "start_time": datetime.now()}
    await chat.send_message("ุจุงุฒ ุชุงูพ ุณุฑุนุช ณ... ฒ... ฑ...")
    image_file = create_typing_image(sentence)
    await chat.send_photo(photo=image_file, caption="ุณุฑุน ุชุงูพ ฺฉูุฏ!")


async def handle_typing_attempt(update: Update, context: ContextTypes.DEFAULT_TYPE):
    chat_id = update.effective_chat.id
    if chat_id not in active_games['typing']: return
    if not await pre_command_check(update, context): return
    
    game = active_games['typing'][chat_id]
    user_input = update.message.text.strip()
    
    if user_input == game['sentence']:
        duration = (datetime.now() - game['start_time']).total_seconds()
        user = update.effective_user
        await update.message.reply_text(f"๐ {user.mention_html()} ุจุฑูุฏู ุดุฏ!\nุฒูุงู: **{duration:.2f}** ุซุงูู", parse_mode=ParseMode.HTML)
        del active_games['typing'][chat_id]

# ======================= GAME PANEL (Final Version) =======================

async def game_panel_trigger(update: Update, context: ContextTypes.DEFAULT_TYPE):
    intro_text = (
        f"๐ ุจู ูพูู ุจุงุฒโูุง ุฑุงููฺฏู ุฎูุด ุขูุฏุฏ!\n\n"
        f"ุจุฑุง ุงุณุชูุงุฏู ุงุฒ ุฑุจุงุช ู ุดุฑฺฉุช ุฏุฑ ุจุงุฒโูุงุ ุงุจุชุฏุง ุจุงุฏ ุฏุฑ ฺฉุงูุงู ูุง ุนุถู ุดูุฏ:\n"
        f"โก๏ธ {FORCED_JOIN_CHANNEL}\n\n"
        "ูพุณ ุงุฒ ุนุถูุชุ ุจุฑุง ุดุฑูุน ุฑู ุฏฺฉูู ุฒุฑ ฺฉูฺฉ ฺฉูุฏ:"
    )
    keyboard = [
        [InlineKeyboardButton("๐ฎ ูุดุงูุฏู ูุณุช ุจุงุฒโูุง", callback_data="panel_show_main")],
        [InlineKeyboardButton("๐จโ๐ป ูพุดุชุจุงู ุฑุจุงุช", url=f"https://t.me/{SUPPORT_USERNAME}")]
    ]
    
    await update.message.reply_text(intro_text, reply_markup=InlineKeyboardMarkup(keyboard))

async def game_panel_callback(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    user = query.from_user
    chat = query.message.chat
    data = query.data

    # This check applies to almost all panel interactions
    if not await is_user_in_channel(user.id, context):
        await query.answer(f"โ๏ธุจุฑุง ุงุณุชูุงุฏู ุงุฒ ูพููุ ุงุจุชุฏุง ุจุงุฏ ุฏุฑ ฺฉุงูุงู {FORCED_JOIN_CHANNEL} ุนุถู ุดูุฏ.", show_alert=True)
        return

    if data == "panel_show_main":
        await query.answer()
        main_text = "๐น๏ธ **ูพูู ุจุงุฒโูุง**\n\nฺฉ ุจุงุฒ ุฑุง ุจุฑุง ุดุฑูุน ุงูุชุฎุงุจ ฺฉูุฏ:"
        keyboard = [
            [InlineKeyboardButton("โ๏ธ ุญฺฉู", callback_data="panel_show_hokm"), InlineKeyboardButton("โโญ๏ธ ุฏูุฒ", callback_data="panel_show_dooz")],
            [InlineKeyboardButton("๐ต๏ธโโ๏ธ ุญุฏุณ ฺฉููู", callback_data="panel_show_hads_kalame"), InlineKeyboardButton("๐ข ุญุฏุณ ุนุฏุฏ", callback_data="panel_show_hads_addad")],
            [InlineKeyboardButton("โจ๏ธ ุชุงูพ ุณุฑุนุช", callback_data="panel_show_type"), InlineKeyboardButton("๐ ูุงุฑฺ", callback_data="panel_show_gharch")],
            [InlineKeyboardButton("๐คซ ุงุนุชุฑุงู", callback_data="panel_show_eteraf")],
            [InlineKeyboardButton("โ๏ธ ุจุณุชู ูพูู", callback_data="panel_close")]
        ]
        try:
            await query.edit_message_text(main_text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode=ParseMode.MARKDOWN)
        except Exception as e:
            logger.error(f"Error editing message to main panel: {e}")
            await query.message.delete()
            await chat.send_message(main_text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode=ParseMode.MARKDOWN)

    elif data == "panel_close":
        await query.answer()
        await query.message.delete()

    elif data == "panel_show_hokm":
        await query.answer()
        text = "โ๏ธ **ุจุงุฒ ุญฺฉู**\n\nุญุงูุช ุจุงุฒ ุฏู ููุฑู ุง ฺูุงุฑ ููุฑู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ:"
        keyboard = [
            [
                InlineKeyboardButton("๐ ฒ ููุฑู", callback_data="hokm_start_2p"),
                InlineKeyboardButton("๐จโ๐ฉโ๐งโ๐ฆ ด ููุฑู", callback_data="hokm_start_4p")
            ],
            [InlineKeyboardButton("๐ ุจุงุฒฺฏุดุช ุจู ูพูู", callback_data="panel_show_main")]
        ]
        await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))

    elif data == "panel_show_dooz":
        await query.answer()
        text = "โโญ๏ธ **ุดุฑูุน ุจุงุฒ ุฏูุฒ**\n\nฺฺฏููู ูโุฎูุงูุฏ ุจุงุฒ ุฑุง ุดุฑูุน ฺฉูุฏุ"
        keyboard = [
            [InlineKeyboardButton("๐ฒ ุงุฌุงุฏ ูุงุจ ุจุงุฒ (ุนููู)", callback_data="dooz_create_lobby")],
            [InlineKeyboardButton("๐ฏ ฺุงูุด ุจุง ฺฉ ฺฉุงุฑุจุฑ (ูุณุชูู)", callback_data="dooz_start_challenge")],
            [InlineKeyboardButton("๐ ุจุงุฒฺฏุดุช ุจู ูพูู", callback_data="panel_show_main")]
        ]
        await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))
        
    elif data == "dooz_create_lobby":
        await query.answer()
        text = (
            f"๐ฒ {user.mention_html()} ฺฉ ูุงุจ ุจุงุฒ ุฏูุฒ ุงุฌุงุฏ ฺฉุฑุฏ ู ููุชุธุฑ ุญุฑู ุงุณุช!\n\n"
            f"โ๏ธ ุจุฑุง ูพูุณุชูุ ุงุจุชุฏุง ุฏุฑ ฺฉุงูุงู {FORCED_JOIN_CHANNEL} ุนุถู ุดูุฏ."
        )
        keyboard = [[InlineKeyboardButton("โ๏ธ ูพูุณุชู ุจู ุจุงุฒ", callback_data=f"dooz_join_lobby_{user.id}")]]
        await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard), parse_mode=ParseMode.HTML)

    elif data == "panel_show_hads_kalame":
        await query.answer()
        await query.message.delete()
        await hads_kalame_command(query, context) # Pass query to get chat info

    elif data == "panel_show_type":
        await query.answer()
        await query.message.delete()
        await type_command(query, context) # Pass query to get chat info

    elif data in ["panel_show_hads_addad", "panel_show_gharch", "panel_show_eteraf"]:
        if not await is_group_admin(user.id, chat.id, context):
            await query.answer("โ ุงู ูุงุจูุช ููุท ุชูุณุท ุงุฏููโูุง ูุงุจู ุงุณุชูุงุฏู ุงุณุช.", show_alert=True)
            return
        
        if data == "panel_show_hads_addad":
            await query.answer()
            await query.message.delete()
            await hads_addad_command(query.message, context) # Start conversation
            
        elif data == "panel_show_gharch":
            await query.answer()
            await query.message.delete()
            await gharch_command(query.message, context) # Start conversation
            
        elif data == "panel_show_eteraf":
            await query.answer()
            text = "๐คซ **ุดุฑูุน ุงุนุชุฑุงู**\n\nูุทูุงู ููุน ูุชู ุฑุง ุงูุชุฎุงุจ ฺฉูุฏ:"
            keyboard = [
                [InlineKeyboardButton("๐ ูุชู ูพุดโูุฑุถ", callback_data="eteraf_default")],
                [InlineKeyboardButton("โ๏ธ ูุชู ุณูุงุฑุด", callback_data="eteraf_custom")],
                [InlineKeyboardButton("๐ ุจุงุฒฺฏุดุช ุจู ูพูู", callback_data="panel_show_main")]
            ]
            await query.edit_message_text(text, reply_markup=InlineKeyboardMarkup(keyboard))

    elif data == "eteraf_default":
        if not await is_group_admin(user.id, chat.id, context):
            await query.answer("โ ุงู ูุงุจูุช ููุท ุชูุณุท ุงุฏููโูุง ูุงุจู ุงุณุชูุงุฏู ุงุณุช.", show_alert=True)
            return
        await query.answer()
        await query.message.delete()
        starter_text = "ฺฉ ููุถูุน ุงุนุชุฑุงู ุฌุฏุฏ ุดุฑูุน ุดุฏ. ุจุฑุง ุงุฑุณุงู ุงุนุชุฑุงู ูุงุดูุงุณ (ฺฉู ุจู ุงู ูพุงู ุฑูพูุง ูโุดูุฏ)ุ ุงุฒ ุฏฺฉูู ุฒุฑ ุงุณุชูุงุฏู ฺฉูุฏ."
        bot_username = (await context.bot.get_me()).username
        starter_message = await chat.send_message(starter_text)
        keyboard = [[InlineKeyboardButton("๐คซ ุงุฑุณุงู ุงุนุชุฑุงู", url=f"https://t.me/{bot_username}?start=eteraf_{chat.id}_{starter_message.message_id}")]]
        await starter_message.edit_reply_markup(reply_markup=InlineKeyboardMarkup(keyboard))


# =================================================================
# ================= OWNER & CORE COMMANDS START ===================
# =================================================================
async def placeholder_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await pre_command_check(update, context): return
    await update.message.reply_text(f"ูุงุจูุช `{update.message.text.split()[0]}` ุฏุฑ ุขูุฏู ุงุถุงูู ุฎูุงูุฏ ุดุฏ.", parse_mode=ParseMode.MARKDOWN)

async def start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    chat_id = update.effective_chat.id

    if context.args:
        try:
            payload = context.args[0]
            parts = payload.split('_')
            game_type, target_chat_id = parts[0], int(parts[1])

            if game_type == "gharch":
                if target_chat_id in active_gharch_games:
                    god_username = active_gharch_games[target_chat_id]['god_username']
                    context.user_data['anon_target_chat'] = {'id': target_chat_id, 'type': game_type}
                    prompt = f"ูพุงู ุฎูุฏ ุฑุง ุจุฑุง ุงุฑุณุงู ูุงุดูุงุณ ุจููุณุฏ...\n\nุชูุฌู: ููุท ฺฏุงุฏ ุจุงุฒ ({god_username}) ููุช ุดูุง ุฑุง ุฎูุงูุฏ ุฏุฏ."
                    await update.message.reply_text(prompt)
                    return
                else:
                    await update.message.reply_text("ุงู ุจุงุฒ ูุงุฑฺ ุฏฺฏุฑ ูุนุงู ูุณุช."); return
            
            elif game_type == "eteraf":
                context.user_data['anon_target_chat'] = {'id': target_chat_id, 'type': game_type}
                if len(parts) > 2:
                    context.user_data['anon_target_chat']['reply_to'] = int(parts[2])
                prompt = "ุงุนุชุฑุงู ุฎูุฏ ุฑุง ุจููุณุฏ ุชุง ุจู ุตูุฑุช ูุงุดูุงุณ ุฏุฑ ฺฏุฑูู ุงุฑุณุงู ุดูุฏ..."
                await update.message.reply_text(prompt)
                return

        except (ValueError, IndexError):
            pass 

    conn = get_db_connection()
    if conn:
        with conn.cursor() as cur: 
            cur.execute("INSERT INTO users (user_id, first_name, username) VALUES (%s, %s, %s) ON CONFLICT (user_id) DO NOTHING;", (user.id, user.first_name, user.username))
            conn.commit()
    
    if not await pre_command_check(update, context):
        if conn: conn.close()
        return

    keyboard = [
        [InlineKeyboardButton("โ ุงูุฒูุฏู ุฑุจุงุช ุจู ฺฏุฑูู", url=f"https://t.me/{(await context.bot.get_me()).username}?startgroup=true")],
        [InlineKeyboardButton("๐ค ุงุฑุชุจุงุท ุจุง ูพุดุชุจุงู", url=f"https://t.me/{SUPPORT_USERNAME}")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)

    custom_welcome_sent = False
    if conn:
        try:
            with conn.cursor() as cur:
                cur.execute("SELECT message_id, chat_id FROM start_message WHERE id = 1;")
                start_msg_data = cur.fetchone()
                if start_msg_data:
                    message_id, from_chat_id = start_msg_data
                    await context.bot.copy_message(chat_id=chat_id, from_chat_id=from_chat_id, message_id=message_id, reply_markup=reply_markup)
                    custom_welcome_sent = True
        except Exception as e:
            logger.error(f"Could not send custom start message in PV: {e}")
        finally:
            conn.close()

    if not custom_welcome_sent:
        await update.message.reply_text("ุณูุงู ุจู ุฑุงููุจุงุฒ ุฎูุด ุขูุฏุฏ.", reply_markup=reply_markup)
    
    report_text = f"โ ฺฉุงุฑุจุฑ ุฌุฏุฏ: {user.mention_html()} (ID: `{user.id}`)"
    for owner_id in OWNER_IDS:
        try:
            await context.bot.send_message(chat_id=owner_id, text=report_text, parse_mode=ParseMode.HTML)
        except:
            pass

async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await pre_command_check(update, context): return
    help_text = "ุฑุงูููุง ุฑุจุงุช ๐ฎ\n\nุจุง ุงุฑุณุงู ฺฉููู ยซุจุงุฒยป ุง ยซฺฏูยป ูพูู ุจุงุฒโูุง ุฑุง ูุดุงูุฏู ฺฉูุฏ."
    await update.message.reply_text(help_text)

# --- Owner Commands ---
async def set_start_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await is_owner(update.effective_user.id): return
    if not update.message.reply_to_message: return await update.message.reply_text("ุฑู ฺฉ ูพุงู ุฑูพูุง ฺฉูุฏ.")
    msg = update.message.reply_to_message
    conn = get_db_connection()
    if conn:
        with conn.cursor() as cur: cur.execute("INSERT INTO start_message (id, message_id, chat_id) VALUES (1, %s, %s) ON CONFLICT (id) DO UPDATE SET message_id = EXCLUDED.message_id, chat_id = EXCLUDED.chat_id;", (msg.message_id, msg.chat_id)); conn.commit()
        conn.close()
        await update.message.reply_text("โ ูพุงู ุฎูุดุงูุฏฺฏู ุชูุธู ุดุฏ.")

async def stats_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await is_owner(update.effective_user.id): return
    conn = get_db_connection()
    if conn:
        with conn.cursor() as cur:
            cur.execute("SELECT COUNT(*) FROM users;"); user_count = cur.fetchone()[0]
            cur.execute("SELECT COUNT(*) FROM groups;"); group_count = cur.fetchone()[0]
            cur.execute("SELECT SUM(member_count) FROM groups;"); total_members = cur.fetchone()[0] or 0
        stats = f"๐ **ุขูุงุฑ ุฑุจุงุช**\n\n๐ค ฺฉุงุฑุจุฑุงู: {user_count}\n๐ฅ ฺฏุฑููโูุง: {group_count}\n๐จโ๐ฉโ๐งโ๐ฆ ูุฌููุน ุงุนุถุง: {total_members}"
        await update.message.reply_text(stats, parse_mode=ParseMode.MARKDOWN)
        conn.close()
        
async def broadcast_command(update: Update, context: ContextTypes.DEFAULT_TYPE, target: str):
    if not await is_owner(update.effective_user.id): return
    if not update.message.reply_to_message: return await update.message.reply_text("ุฑู ฺฉ ูพุงู ุฑูพูุง ฺฉูุฏ.")
    conn, table, column = get_db_connection(), "users" if target == "users" else "groups", "user_id" if target == "users" else "group_id"
    if not conn: return
    with conn.cursor() as cur: cur.execute(f"SELECT {column} FROM {table};"); targets = cur.fetchall()
    conn.close()
    if not targets: return await update.message.reply_text("ูุฏู ุงูุช ูุดุฏ.")
    
    sent, failed = 0, 0
    status_msg = await update.message.reply_text(f"โณ ุฏุฑ ุญุงู ุงุฑุณุงู ุจู {len(targets)} {target}...")
    for (target_id,) in targets:
        try:
            await context.bot.forward_message(chat_id=target_id, from_chat_id=update.message.reply_to_message.chat.id, message_id=update.message.reply_to_message.message_id)
            sent += 1
        except Exception as e:
            failed += 1
            logger.error(f"Broadcast failed for {target_id}: {e}")
    await status_msg.edit_text(f"๐ ุงุฑุณุงู ุชูุงู ุดุฏ.\n\nโ ูููู: {sent}\nโ ูุงูููู: {failed}")

async def fwdusers_command(update: Update, context: ContextTypes.DEFAULT_TYPE): await broadcast_command(update, context, "users")
async def fwdgroups_command(update: Update, context: ContextTypes.DEFAULT_TYPE): await broadcast_command(update, context, "groups")

async def leave_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await is_owner(update.effective_user.id): return
    if not context.args: return await update.message.reply_text("ุงุณุชูุงุฏู: /leave <group_id>")
    try:
        group_id = int(context.args[0])
        await context.bot.leave_chat(group_id)
        await update.message.reply_text(f"โ ุจุง ููููุช ุงุฒ ฺฏุฑูู `{group_id}` ุฎุงุฑุฌ ุดุฏู.", parse_mode=ParseMode.MARKDOWN)
    except Exception as e:
        await update.message.reply_text(f"ุฎุทุง: {e}")

async def grouplist_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await is_owner(update.effective_user.id): return
    conn = get_db_connection()
    if conn:
        with conn.cursor() as cur:
            cur.execute("SELECT group_id, title, member_count FROM groups;")
            groups = cur.fetchall()
        conn.close()
        if not groups: return await update.message.reply_text("ุฑุจุงุช ุฏุฑ ูฺ ฺฏุฑูู ุนุถู ูุณุช.")
        message = "๐ **ูุณุช ฺฏุฑููโูุง:**\n\n"
        for i, (group_id, title, member_count) in enumerate(groups, 1):
            message += f"{i}. **{title}**\n   - ID: `{group_id}`\n   - ุงุนุถุง: {member_count}\n\n"
        await update.message.reply_text(message, parse_mode=ParseMode.MARKDOWN)

async def join_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await is_owner(update.effective_user.id): return
    if not context.args: return await update.message.reply_text("ุงุณุชูุงุฏู: /join <group_id>")
    try:
        group_id = int(context.args[0])
        link = await context.bot.create_chat_invite_link(group_id, member_limit=30)
        await update.message.reply_text(f"ููฺฉ ูุฑูุฏ ุดูุง:\n{link.invite_link}")
    except Exception as e:
        await update.message.reply_text(f"ุฎุทุง ุฏุฑ ุณุงุฎุช ููฺฉ (ุดุงุฏ ุฑุจุงุช ุงุฏูู ูุจุงุดุฏ): {e}")

async def ban_user_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await is_owner(update.effective_user.id): return
    if not context.args: return await update.message.reply_text("ุงุณุชูุงุฏู: /ban_user <user_id>")
    try:
        user_id = int(context.args[0])
        conn = get_db_connection()
        if conn:
            with conn.cursor() as cur: cur.execute("INSERT INTO banned_users (user_id) VALUES (%s) ON CONFLICT DO NOTHING;", (user_id,))
            conn.commit(); conn.close()
            await update.message.reply_text(f"ฺฉุงุฑุจุฑ `{user_id}` ุจุง ููููุช ูุณุฏูุฏ ุดุฏ.", parse_mode=ParseMode.MARKDOWN)
    except: await update.message.reply_text("ุขุฏ ูุงูุนุชุจุฑ ุงุณุช.")

async def unban_user_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await is_owner(update.effective_user.id): return
    if not context.args: return await update.message.reply_text("ุงุณุชูุงุฏู: /unban_user <user_id>")
    try:
        user_id = int(context.args[0])
        conn = get_db_connection()
        if conn:
            with conn.cursor() as cur: cur.execute("DELETE FROM banned_users WHERE user_id = %s;", (user_id,))
            conn.commit(); conn.close()
            await update.message.reply_text(f"ฺฉุงุฑุจุฑ `{user_id}` ุจุง ููููุช ุงุฒ ูุณุฏูุฏุช ุฎุงุฑุฌ ุดุฏ.", parse_mode=ParseMode.MARKDOWN)
    except: await update.message.reply_text("ุขุฏ ูุงูุนุชุจุฑ ุงุณุช.")

async def ban_group_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await is_owner(update.effective_user.id): return
    if not context.args: return await update.message.reply_text("ุงุณุชูุงุฏู ุตุญุญ: /ban_group <group_id>")
    
    try:
        group_id = int(context.args[0])
        conn = get_db_connection()
        if conn:
            with conn.cursor() as cur:
                cur.execute("INSERT INTO banned_groups (group_id) VALUES (%s) ON CONFLICT DO NOTHING;", (group_id,))
            conn.commit()
            conn.close()
            await update.message.reply_text(f"ฺฏุฑูู `{group_id}` ุจุง ููููุช ูุณุฏูุฏ ุดุฏ.", parse_mode=ParseMode.MARKDOWN)
            
            try:
                await context.bot.leave_chat(group_id)
            except Exception as e:
                logger.warning(f"Could not leave the banned group {group_id}: {e}")

    except (ValueError, IndexError):
        await update.message.reply_text("ูุทูุง ฺฉ ุขุฏ ุนุฏุฏ ูุนุชุจุฑ ุจุฑุง ฺฏุฑูู ูุงุฑุฏ ฺฉูุฏ.")

async def unban_group_command(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if not await is_owner(update.effective_user.id): return
    if not context.args: return await update.message.reply_text("ุงุณุชูุงุฏู ุตุญุญ: /unban_group <group_id>")

    try:
        group_id = int(context.args[0])
        conn = get_db_connection()
        if conn:
            with conn.cursor() as cur:
                cur.execute("DELETE FROM banned_groups WHERE group_id = %s;", (group_id,))
            conn.commit()
            conn.close()
            await update.message.reply_text(f"ฺฏุฑูู `{group_id}` ุจุง ููููุช ุงุฒ ูุณุฏูุฏุช ุฎุงุฑุฌ ุดุฏ.", parse_mode=ParseMode.MARKDOWN)
    except (ValueError, IndexError):
        await update.message.reply_text("ูุทูุง ฺฉ ุขุฏ ุนุฏุฏ ูุนุชุจุฑ ุจุฑุง ฺฏุฑูู ูุงุฑุฏ ฺฉูุฏ.")

async def track_chats(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    result = update.chat_member
    if not result: return

    chat = result.chat
    user = result.from_user
    
    if result.new_chat_member.user.id != context.bot.id:
        return

    if result.new_chat_member.status == 'member' and result.old_chat_member.status != 'member':
        conn = get_db_connection()
        if not conn: return
        
        try:
            with conn.cursor() as cur:
                cur.execute("SELECT COUNT(*) FROM groups;")
                group_count = cur.fetchone()[0]
            
            if group_count >= GROUP_INSTALL_LIMIT:
                await chat.send_message(f"โ๏ธ ุธุฑูุช ูุตุจ ุงู ุฑุจุงุช ุชฺฉูู ุดุฏู ุงุณุช! ูุทูุงู ุจุง ูพุดุชุจุงู (@{SUPPORT_USERNAME}) ุชูุงุณ ุจฺฏุฑุฏ.")
                await context.bot.leave_chat(chat.id)
                for owner_id in OWNER_IDS:
                    await context.bot.send_message(owner_id, f"๐ ูุดุฏุงุฑ: ุณูู ูุตุจ ({GROUP_INSTALL_LIMIT}) ุชฺฉูู ุดุฏ. ุฑุจุงุช ุงุฒ ฺฏุฑูู `{chat.title}` ุฎุงุฑุฌ ุดุฏ.", parse_mode=ParseMode.MARKDOWN)
                conn.close()
                return
        except Exception as e:
            logger.error(f"Could not check group install limit: {e}")

        member_count = await chat.get_member_count()
        with conn.cursor() as cur:
            cur.execute("INSERT INTO groups (group_id, title, member_count) VALUES (%s, %s, %s) ON CONFLICT (group_id) DO UPDATE SET title = EXCLUDED.title, member_count = EXCLUDED.member_count;", (chat.id, chat.title, member_count))
            conn.commit()

        custom_welcome_sent = False
        try:
            with conn.cursor() as cur:
                cur.execute("SELECT message_id, chat_id FROM start_message WHERE id = 1;")
                start_msg_data = cur.fetchone()
                if start_msg_data:
                    message_id, from_chat_id = start_msg_data
                    await context.bot.copy_message(chat_id=chat.id, from_chat_id=from_chat_id, message_id=message_id)
                    custom_welcome_sent = True
        except Exception as e:
            logger.error(f"Could not send custom start message: {e}")

        if not custom_welcome_sent:
            await chat.send_message("ุณูุงู! ๐ ูู ุจุง ููููุช ูุตุจ ุดุฏู.\nุจุฑุง ูุดุงูุฏู ูุณุช ุจุงุฒโูุง ฺฉููู ยซุจุงุฒยป ุฑุง ุงุฑุณุงู ฺฉูุฏ.")
        
        conn.close()
        
        report = f"โ **ุฑุจุงุช ุจู ฺฏุฑูู ุฌุฏุฏ ุงุถุงูู ุดุฏ:**\n\n๐ ูุงู: {chat.title}\n๐: `{chat.id}`\n๐ฅ ุงุนุถุง: {member_count}\n\n๐ค ุชูุณุท: {user.mention_html()} (ID: `{user.id}`)"
        for owner_id in OWNER_IDS:
            try: await context.bot.send_message(owner_id, report, parse_mode=ParseMode.HTML)
            except: pass

    elif result.new_chat_member.status == 'left':
        conn = get_db_connection()
        if conn:
            with conn.cursor() as cur:
                cur.execute("DELETE FROM groups WHERE group_id = %s;", (chat.id,))
                conn.commit()
            conn.close()
        report = f"โ **ุฑุจุงุช ุงุฒ ฺฏุฑูู ุฒุฑ ุงุฎุฑุงุฌ ุดุฏ:**\n\n๐ ูุงู: {chat.title}\n๐: `{chat.id}`"
        for owner_id in OWNER_IDS:
            try: await context.bot.send_message(owner_id, report, parse_mode=ParseMode.MARKDOWN)
            except: pass

# ======================== MAIN FUNCTION ==========================

def main() -> None:
    """Start the bot."""
    setup_database()
    BOT_TOKEN = os.environ.get("BOT_TOKEN")
    if not BOT_TOKEN:
        logger.critical("BOT_TOKEN environment variable not set.")
        return

    application = Application.builder().token(BOT_TOKEN).build()

    # --- Conversation Handlers ---
    gharch_conv_handler = ConversationHandler(
        entry_points=[CommandHandler("gharch", gharch_command)],
        states={
            ASKING_GOD_USERNAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, receive_god_username)],
            CONFIRMING_GOD: [CallbackQueryHandler(confirm_god, pattern=r'^gharch_confirm_god_')],
        },
        fallbacks=[CommandHandler('cancel', cancel_gharch)],
        per_user=False, per_chat=True,
    )
    
    guess_number_conv = ConversationHandler(
        entry_points=[CommandHandler("hads_addad", hads_addad_command)],
        states={
            SELECTING_RANGE: [MessageHandler(filters.Regex(r'^\d+-\d+$'), receive_range)],
            GUESSING: [MessageHandler(filters.Regex(r'^[\dฐ-น]+$'), handle_guess_conversation)],
        },
        fallbacks=[CommandHandler('cancel', cancel_game)],
        per_user=False, per_chat=True
    )

    dooz_conv_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(dooz_start_direct_challenge, pattern=r'^dooz_start_challenge$')],
        states={
            DOOZ_ASKING_OPPONENT: [MessageHandler(filters.TEXT & ~filters.COMMAND, dooz_receive_opponent)]
        },
        fallbacks=[CallbackQueryHandler(game_panel_callback, pattern=r'^panel_show_main$')],
        conversation_timeout=60
    )

    eteraf_conv_handler = ConversationHandler(
        entry_points=[CallbackQueryHandler(eteraf_start_custom_text, pattern=r'^eteraf_custom$')],
        states={
            ETERAF_ASKING_CUSTOM_TEXT: [MessageHandler(filters.TEXT & ~filters.COMMAND, eteraf_receive_custom_text)]
        },
        fallbacks=[CallbackQueryHandler(game_panel_callback, pattern=r'^panel_show_main$')],
        conversation_timeout=120
    )

    application.add_handler(gharch_conv_handler)
    application.add_handler(guess_number_conv)
    application.add_handler(dooz_conv_handler)
    application.add_handler(eteraf_conv_handler)

    # --- Command Handlers ---
    application.add_handler(CommandHandler("start", start_command))
    application.add_handler(CommandHandler("help", help_command))
    
    application.add_handler(CommandHandler("hokm", hokm_command))
    application.add_handler(CommandHandler("dooz", dooz_command))
    application.add_handler(CommandHandler("hads_kalame", hads_kalame_command))
    application.add_handler(CommandHandler("type", type_command))
    application.add_handler(CommandHandler("eteraf", eteraf_command))
    
    application.add_handler(CommandHandler("top", placeholder_command))
    application.add_handler(CommandHandler("settings", placeholder_command))

    application.add_handler(CommandHandler("setstart", set_start_command))
    application.add_handler(CommandHandler("stats", stats_command))
    application.add_handler(CommandHandler("fwdusers", fwdusers_command))
    application.add_handler(CommandHandler("fwdgroups", fwdgroups_command))
    application.add_handler(CommandHandler("leave", leave_command))
    application.add_handler(CommandHandler("grouplist", grouplist_command))
    application.add_handler(CommandHandler("join", join_command))
    application.add_handler(CommandHandler("ban_user", ban_user_command))
    application.add_handler(CommandHandler("unban_user", unban_user_command))
    application.add_handler(CommandHandler("ban_group", ban_group_command))
    application.add_handler(CommandHandler("unban_group", unban_group_command))

    # --- CallbackQuery Handlers ---
    application.add_handler(CallbackQueryHandler(hokm_callback, pattern=r'^hokm_'))
    application.add_handler(CallbackQueryHandler(dooz_callback, pattern=r'^dooz_'))
    application.add_handler(CallbackQueryHandler(game_panel_callback, pattern=r'^panel_'))

    # --- Message Handlers ---
    application.add_handler(MessageHandler(filters.Regex(r'^(ุจุงุฒ|ฺฏู|ุฑุงููฺฏู)$') & filters.ChatType.GROUPS, game_panel_trigger))
    
    application.add_handler(MessageHandler(filters.Regex(r'^[ุข-]$') & filters.ChatType.GROUPS, handle_letter_guess))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND & filters.ChatType.PRIVATE, handle_anonymous_message))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND & filters.ChatType.GROUPS, handle_typing_attempt))
    
    # --- Other Handlers ---
    application.add_handler(ChatMemberHandler(track_chats, ChatMemberHandler.MY_CHAT_MEMBER))
    
    logger.info("Bot is starting with all new features and fixes...")
    application.run_polling()

if __name__ == "__main__":
    main()
